<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="format-detection" content="telephone=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="full-screen" content="yes">
<meta name="x5-fullscreen" content="true">
<meta name="browsermode" content="application">
<meta name="x5-page-mode" content="app">
<meta name="theme-color" content="#000000">
<link rel="manifest" href="/manifest.json">
<link rel="icon" type="image/png" href="/apple-touch-icon.png">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">
<title>Magic Control</title>
<style>
:root {
    --bg-color: #000;
    --text-color: #fff;
    --primary: #007aff;
    --surface: #1c1c1e;
    --border: #333;
    --danger: #ff3b30;
    --key-bg: rgba(255,255,255,0.15);
    --key-active: rgba(255,255,255,0.4);
}
@media (prefers-color-scheme: light) {
    :root {
        --bg-color: #f2f2f7;
        --text-color: #000;
        --surface: #fff;
        --border: #c6c6c8;
        --key-bg: rgba(0,0,0,0.1);
        --key-active: rgba(0,0,0,0.2);
    }
}
/* Manual Theme Overrides */
body.theme-dark { --bg-color: #000; --text-color: #fff; --surface: #1c1c1e; --border: #333; --key-bg: rgba(255,255,255,0.15); --key-active: rgba(255,255,255,0.4); }
body.theme-light { --bg-color: #f2f2f7; --text-color: #000; --surface: #fff; --border: #c6c6c8; --key-bg: rgba(0,0,0,0.1); --key-active: rgba(0,0,0,0.2); }

html { width: 100%; height: 100%; overflow: hidden; overscroll-behavior: none; background-color: #000; }
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; -webkit-touch-callout: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; overscroll-behavior: none; touch-action: pan-y; }

textarea,
input,
[contenteditable="true"],
#peek-memo-input {
    -webkit-user-select: text;
    -moz-user-select: text;
    -ms-user-select: text;
    user-select: text;
}
body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: linear-gradient(180deg, #1c1c1e 0%, #000000 100%); color: var(--text-color); overflow: hidden; height: 100vh; width: 100%; }

/* SVG Sprite */
.icon { width: 20px; height: 20px; fill: currentColor; }

/* Layout */
#app { width: 100%; height: 100%; position: relative; overflow: hidden; }
.view { 
    position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
    display: none; 
    overflow-y: auto; 
    background: transparent;
    -webkit-overflow-scrolling: touch;
    overscroll-behavior: contain;
}
.view.active { display: block; }
#performance-view { background-size: cover; background-position: center; background-color: #000; overflow: hidden; } /* Ensure no scroll */

/* Settings View */
#settings-view { padding: 20px; padding-top: calc(20px + env(safe-area-inset-top)); background: transparent; color: #fff; }
#peek-settings-view { padding: 20px; padding-top: calc(20px + env(safe-area-inset-top)); background: transparent; color: #fff; }
.card { background: #1c1c1e; border-radius: 12px; padding: 16px; margin-bottom: 16px; }
.form-group { margin-bottom: 12px; }
label { display: block; margin-bottom: 8px; font-size: 14px; color: #8e8e93; }
input, select { width: 100%; padding: 12px; background: #2c2c2e; border: 1px solid #3a3a3c; border-radius: 8px; color: #fff; font-size: 16px; outline: none; }
input[type="checkbox"] { width: auto; padding: 0; margin: 0; height: 20px; width: 20px; vertical-align: middle; accent-color: var(--primary); }
input:focus { border-color: var(--primary); }
.btn { width: 100%; padding: 14px; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; background: var(--primary); color: #fff; transition: opacity 0.2s; }
.btn:active { opacity: 0.7; }
.btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); }

/* Lock Screen */
.lock-screen { 
    position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10;
    display: flex; flex-direction: column; align-items: center; justify-content: flex-start; 
    padding-top: calc(15vh + env(safe-area-inset-top));
    background: rgba(0,0,0,0.15); /* Slight tint */
    backdrop-filter: blur(35px); -webkit-backdrop-filter: blur(35px); /* Strong blur */
    color: #fff;
}
.pass-title { font-size: 22px; margin-bottom: 20px; font-weight: 400; letter-spacing: 0.5px; }
.pass-dots { display: flex; margin-bottom: 40px; }
.dot { width: 13px; height: 13px; border-radius: 50%; border: 1.5px solid #fff; transition: background 0.2s; box-sizing: border-box; margin: 0 12px; }
.dot.filled { background: #fff; }

.keypad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 25px; row-gap: 20px; }
.key-btn { 
    width: 78px; height: 78px; border-radius: 50%; 
    background: var(--key-bg); backdrop-filter: blur(10px);
    color: #fff; display: flex; flex-direction: column; align-items: center; justify-content: center; 
    cursor: pointer; transition: background 0.1s; 
    border: none;
}
.key-btn:active { background: var(--key-active); }
.key-num { font-size: 34px; line-height: 34px; font-weight: 400; }
.key-sub { font-size: 10px; letter-spacing: 2px; font-weight: 700; margin-top: 2px; text-transform: uppercase; }

.bottom-actions { 
    position: absolute; bottom: 50px; width: 80%; display: flex; justify-content: space-between; 
    font-size: 16px; font-weight: 600; 
}
.action-btn { background: none; border: none; color: #fff; font-size: 16px; font-weight: 600; cursor: pointer; }

/* WiFi Screen */
.wifi-screen { height: 100%; display: none; flex-direction: column; background: var(--bg-color); color: var(--text-color); }
.ios-header { 
    padding: 10px 8px; padding-top: calc(10px + env(safe-area-inset-top)); min-height: 44px; display: flex; align-items: center; justify-content: space-between;
    background: var(--bg-color); 
    font-size: 17px;
}
.header-btn { color: var(--primary); display: flex; align-items: center; cursor: pointer; }
.header-title { font-weight: 600; }

.wifi-content { flex: 1; overflow-y: auto; padding-top: 20px; overscroll-behavior: none; -webkit-overflow-scrolling: touch; }

.group-container { 
    background: var(--surface); border-radius: 10px; margin: 0 16px 20px; overflow: hidden; 
}
.list-row { 
    padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; 
    border-bottom: 0.5px solid var(--border); 
}
.list-row:last-child { border-bottom: none; }

.section-header { 
    margin: 0 16px 8px; color: #8e8e93; font-size: 13px; text-transform: uppercase; 
    display: flex; justify-content: space-between; align-items: center;
}

.wifi-item { 
    display: flex; align-items: center; padding: 12px 0 12px 16px; 
    background: var(--surface);
    cursor: pointer;
    border-bottom: 0.5px solid var(--border);
    margin-left: 16px; /* Inset separator */
}
.wifi-item:last-child { border-bottom: none; }

.wifi-name { flex: 1; font-size: 17px; }
.wifi-icons { display: flex; align-items: center; gap: 8px; padding-right: 16px; }
.icon-lock { fill: #8e8e93; width: 14px; height: 14px; }
.icon-signal { fill: var(--primary); width: 18px; height: 18px; }
.icon-wifi { fill: var(--text-color); width: 18px; height: 18px; }
.icon-info { fill: var(--primary); width: 22px; height: 22px; }

/* Xiaomi Style Overrides */
.wifi-screen.xiaomi {
    --bg-color: #f6f6f6;
    --surface: #fff;
    --text-color: #000;
    --primary: #006cff;
    font-family: "MiSans", -apple-system, sans-serif;
}
.wifi-screen.xiaomi .ios-header {
    background: #f6f6f6;
    padding: 10px 16px;
    padding-top: calc(30px + env(safe-area-inset-top));
    justify-content: space-between;
}
.wifi-screen.xiaomi .header-btn { color: #000; }
.wifi-screen.xiaomi .header-btn span { display: none; }
.wifi-screen.xiaomi .header-title { font-size: 20px; font-weight: 500; margin-left: 0; }
.wifi-screen.xiaomi .group-container {
    border-radius: 12px;
    box-shadow: none;
    margin: 10px 16px;
}
.wifi-screen.xiaomi .wifi-item {
    margin-left: 0;
    padding: 16px 20px;
    border-bottom: 1px solid #f0f0f0;
    justify-content: flex-start;
}
.wifi-screen.xiaomi .section-header {
    text-transform: none;
    font-size: 13px;
    color: #999;
    margin: 20px 24px 8px;
    display: flex;
    justify-content: space-between;
}
.wifi-screen.xiaomi .wifi-sub {
    font-size: 11px; color: #999; margin-top: 4px;
}
.wifi-screen.xiaomi .xiaomi-refresh {
    color: #006cff; font-size: 13px;
}
.wifi-screen.xiaomi .left-icon {
    margin-right: 16px; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;
}
.wifi-screen.xiaomi .right-icon {
    margin-left: auto; width: 24px; height: 24px; fill: #999;
}

/* Vivo Style Overrides */
.wifi-screen.vivo {
    --bg-color: #fff;
    --surface: #fff;
    --text-color: #000;
    --primary: #418df9;
    font-family: sans-serif;
}
.wifi-screen.vivo .ios-header {
    background: #fff;
    padding: 12px 16px;
    padding-top: calc(30px + env(safe-area-inset-top));
    justify-content: space-between;
    height: auto;
    min-height: 50px;
}
.wifi-screen.vivo .header-btn { color: #000; }
.wifi-screen.vivo .header-btn span { display: none; }
.wifi-screen.vivo .header-title { 
    font-size: 18px; 
    font-weight: 600; 
    position: absolute; 
    left: 50%; 
    transform: translateX(-50%);
}
.wifi-screen.vivo .group-container {
    box-shadow: none;
    margin: 0 24px;
    background: #fff;
    border-radius: 0;
}
.wifi-screen.vivo .wifi-item {
    padding: 18px 0;
    border-bottom: none;
    margin-left: 0;
}
.wifi-screen.vivo .section-header {
    margin: 30px 24px 10px;
    font-size: 14px;
    color: #888;
    display: flex;
    justify-content: space-between;
    text-transform: none;
}
.wifi-screen.vivo .vivo-refresh {
    color: var(--primary);
    font-size: 14px;
}
.wifi-screen.vivo .vivo-add {
    color: var(--primary);
    margin: 10px 24px;
    font-size: 16px;
    font-weight: 500;
    display: none;
}
.wifi-screen.vivo .wifi-sub {
    font-size: 12px; color: #999; margin-top: 4px;
}
.wifi-screen.vivo .right-arrow {
    width: 16px; height: 16px; fill: #ccc;
}

/* Huawei Style Overrides */
.wifi-screen.huawei {
    --bg-color: #f2f2f2;
    --surface: #fff;
    --text-color: #000;
    --primary: #007dff;
    font-family: sans-serif;
}
.wifi-screen.huawei .ios-header {
    background: #f2f2f2;
    padding: 10px 16px;
    padding-top: calc(30px + env(safe-area-inset-top));
    justify-content: flex-start;
}
.wifi-screen.huawei .header-btn { color: #000; }
.wifi-screen.huawei .header-btn span { display: none; }
.wifi-screen.huawei .header-title { font-size: 20px; margin-left: 4px; font-weight: 500; }
.wifi-screen.huawei .group-container {
    border-radius: 16px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    margin: 12px 12px;
}
.wifi-screen.huawei .wifi-item {
    margin-left: 0;
    padding: 14px 20px;
    border-bottom: 1px solid #f0f0f0;
}
.wifi-screen.huawei .section-header {
    text-transform: none;
    font-size: 14px;
    color: #666;
    margin: 16px 24px 6px;
}
.wifi-screen.huawei .wifi-sub {
    font-size: 12px; color: #888; margin-top: 2px;
}
.wifi-screen.huawei .huawei-extras { display: block !important; margin-top: 0; }
.wifi-screen.huawei .icon-wifi { width: 20px; height: 20px; fill: #000; }

/* Spinner */
.spinner { width: 16px; height: 16px; border: 2px solid #8e8e93; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

/* Animation & Utils */
.glitch { animation: glitch 0.2s linear infinite; }
@keyframes glitch { 0% { transform: translate(0); } 20% { transform: translate(-2px, 2px); } 40% { transform: translate(-2px, -2px); } 60% { transform: translate(2px, 2px); } 80% { transform: translate(2px, -2px); } 100% { transform: translate(0); } }

.interference { animation: noise 0.2s infinite; filter: contrast(150%) brightness(150%); }
@keyframes noise { 0% { transform: translate(0,0); } 10% { transform: translate(-5px,5px); } 20% { transform: translate(-5px,-5px); } 30% { transform: translate(5px,5px); } 40% { transform: translate(5px,-5px); } 50% { transform: translate(0,0); } }

@keyframes shake {
  0%, 100% { transform: translateX(0); }
  10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
  20%, 40%, 60%, 80% { transform: translateX(10px); }
}
.shake {
  animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
}

/* Poker WiFi Mode Overlay */
.quadrant-overlay {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    z-index: 100; display: none;
}
.quadrant {
    position: absolute; width: 50%; height: 50%;
    touch-action: none; /* Prevent scrolling while inputting suit/value */
}
.q-tl { top: 0; left: 0; }
.q-tr { top: 0; right: 0; }
.q-bl { bottom: 0; left: 0; }
.q-br { bottom: 0; right: 0; }

.wifi-list-loading {
    display: inline-block;
    width: 20px; height: 20px;
    border: 2px solid rgba(0,0,0,0.1);
    border-top-color: var(--primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}
.wifi-list-loading.stopped {
    animation: none;
    border-color: transparent;
    background: transparent;
}

.modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 100; }
.toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: rgba(50,50,50,0.9); color: #fff; padding: 10px 20px; border-radius: 20px; font-size: 14px; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
.toast.show { opacity: 1; }

/* Real iOS Lock Screen Styles */
.ios-lock-screen {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    display: flex; flex-direction: column; align-items: center;
    color: #fff; z-index: 20;
    transition: transform 0.4s ease-in-out, opacity 0.4s;
    padding-top: env(safe-area-inset-top);
    background: linear-gradient(180deg, #1c1c1e 0%, #000000 100%);
    background-size: cover; background-position: center; 
}
.ios-lock-screen.hidden { transform: translateY(-100%); opacity: 0; pointer-events: none; }

.status-bar {
    width: 100%; padding: 12px 24px; display: flex; justify-content: space-between; align-items: center;
    font-size: 14px; font-weight: 500;
}
.status-icons { display: flex; gap: 6px; align-items: center; }
.status-icons .icon { width: 18px; height: 18px; fill: #fff; }

.lock-indicator { margin-top: 10px; margin-bottom: 10px; }

.clock-area { text-align: center; margin-top: 10px; }
.time { font-size: 84px; font-weight: 200; letter-spacing: -2px; line-height: 1; font-family: -apple-system, sans-serif; }
.date { font-size: 20px; font-weight: 400; margin-top: 8px; }
.lunar { font-size: 14px; opacity: 0.8; margin-top: 4px; }

.bottom-shortcuts {
    position: absolute; bottom: 50px; width: 100%; padding: 0 46px;
    display: flex; justify-content: space-between;
}
.shortcut-btn {
    width: 50px; height: 50px; border-radius: 50%;
    background: rgba(30,30,30,0.5); backdrop-filter: blur(10px);
    display: flex; align-items: center; justify-content: center;
}
.shortcut-btn .icon { width: 24px; height: 24px; fill: #fff; }

.home-indicator {
    position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%);
    width: 130px; height: 5px; background: #fff; border-radius: 3px;
}
/* OPPO Style Overrides */
.wifi-screen.oppo {
    --bg-color: #f7f8fa;
    --surface: #fff;
    --text-color: #000;
    --primary: #007aff;
    font-family: sans-serif;
}
.wifi-screen.oppo .ios-header {
    background: #f7f8fa;
    padding: 10px 16px;
    padding-top: calc(30px + env(safe-area-inset-top));
    justify-content: space-between;
}
.wifi-screen.oppo .header-btn { color: #000; }
.wifi-screen.oppo .header-btn span { display: none; }
.wifi-screen.oppo .header-title { 
    font-size: 18px; 
    font-weight: 500; 
    margin-left: 0;
    flex: 1;
    text-align: left;
    padding-left: 10px;
}
.wifi-screen.oppo .group-container {
    background: #fff;
    border-radius: 16px;
    margin: 12px 16px;
    padding: 0 20px;
}
.wifi-screen.oppo .list-row {
    padding: 18px 0;
}
.wifi-screen.oppo .section-header {
    margin: 20px 24px 8px;
    color: #888;
    font-size: 13px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.wifi-screen.oppo .wifi-item {
    padding: 16px 0;
    border-bottom: 1px solid #f5f5f5;
    margin-left: 0;
    display: flex;
    align-items: center;
}
.wifi-screen.oppo .wifi-item:last-child {
    border-bottom: none;
}
.wifi-screen.oppo .wifi-name {
    font-weight: 500;
    font-size: 16px;
}
.wifi-screen.oppo .left-icon {
    margin-right: 12px;
}
.wifi-screen.oppo .right-icon {
    margin-left: 12px;
}
.oppo-refresh {
    color: #007aff;
    font-size: 14px;
    font-weight: 500;
}

/* Samsung Style Overrides */
.wifi-screen.samsung {
    --bg-color: #000;
    --surface: #252525;
    --text-color: #fff;
    --primary: #2196f3;
    font-family: sans-serif;
}
.wifi-screen.samsung .ios-header {
    background: #000;
    color: #fff;
    padding: 10px 16px;
    padding-top: calc(30px + env(safe-area-inset-top));
    justify-content: space-between;
    border-bottom: none;
}
.wifi-screen.samsung .header-title {
    margin-left: 10px;
    font-size: 20px;
    font-weight: 500;
}
.wifi-screen.samsung .header-btn { color: var(--text-color); }
.wifi-screen.samsung .group-container {
    background: var(--surface);
    border-radius: 24px;
    margin: 0 16px 16px;
    padding: 8px 0;
    overflow: hidden;
}
.wifi-screen.samsung .list-row {
    padding: 16px 20px;
    border-bottom: none;
}
.wifi-screen.samsung .section-header {
    margin: 20px 24px 8px;
    font-size: 14px;
    color: #999;
}
.wifi-screen.samsung .wifi-item {
    padding: 16px 20px;
    border-bottom: none;
    margin-left: 0;
}
.wifi-screen.samsung .wifi-name {
    font-size: 16px;
    font-weight: 500;
}
.wifi-screen.samsung .samsung-toggle {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: var(--surface);
    margin: 10px 16px 20px;
    padding: 20px 24px;
    border-radius: 24px;
    font-size: 18px;
    font-weight: 500;
}
.wifi-screen.samsung .samsung-check-btn {
    background: #2196f3;
    color: #fff;
    text-align: center;
    padding: 12px;
    border-radius: 20px;
    margin-top: 16px;
    font-size: 15px;
    font-weight: 600;
    width: 100%;
    display: block;
}
.wifi-screen.samsung .icon-gear {
    fill: #999;
    width: 24px;
    height: 24px;
}

/* Dark Mode Adaptations */
body.theme-dark .wifi-screen.huawei { --bg-color: #000; --surface: #1c1c1e; --text-color: #fff; }
body.theme-dark .wifi-screen.huawei .ios-header { background: #000; }
body.theme-dark .wifi-screen.xiaomi { --bg-color: #000; --surface: #1c1c1e; --text-color: #fff; }
body.theme-dark .wifi-screen.xiaomi .ios-header { background: #000; }
body.theme-dark .wifi-screen.vivo { --bg-color: #000; --surface: #1c1c1e; --text-color: #fff; }
body.theme-dark .wifi-screen.vivo .ios-header { background: #000; }
body.theme-dark .wifi-screen.oppo { --bg-color: #000; --surface: #1c1c1e; --text-color: #fff; }
body.theme-dark .wifi-screen.oppo .ios-header { background: #000; }

/* Light Mode for Samsung */
body.theme-light .wifi-screen.samsung { --bg-color: #f2f2f2; --surface: #fff; --text-color: #000; }
body.theme-light .wifi-screen.samsung .ios-header { background: #f2f2f2; color: #000; }
body.theme-light .wifi-screen.samsung .samsung-toggle { background: #fff; }

/* PEEK Style Overrides */

/* Android / Samsung / Huawei / Xiaomi / Vivo / Oppo Generic Overrides */
.style-android .peek-screen,
.style-samsung .peek-screen,
.style-huawei .peek-screen,
.style-xiaomi .peek-screen,
.style-vivo .peek-screen,
.style-oppo .peek-screen {
    font-family: Roboto, "Segoe UI", sans-serif;
}

/* --- Dialer Overrides --- */
/* Non-iOS Dialers often have no circle borders or different colors */
.style-android .dial-btn,
.style-samsung .dial-btn {
    background: transparent !important;
    border-radius: 0;
    width: 100%;
    height: 60px;
}
.style-android .dial-btn:active,
.style-samsung .dial-btn:active {
    background: rgba(0,0,0,0.1) !important;
}
.style-android .sub, .style-samsung .sub {
    font-size: 12px; color: #999;
}

.style-android .dial-btn:nth-last-child(3),
.style-samsung .dial-btn:nth-last-child(3) {
    background: #00C853 !important;
    border-radius: 50%;
    width: 60px; height: 60px;
    margin: 0 auto;
}

/* Huawei Dialer Overrides */
.style-huawei #peek-dial-screen {
    background: #ffffff !important;
}
.style-huawei #peek-dial-screen > div:first-child {
    align-items: flex-start;
    justify-content: flex-end;
    padding: 20px 24px 0;
}
.style-huawei #peek-dial-num {
    font-size: 32px;
    color: #000000;
    font-weight: 400;
    text-align: center;
    width: 100%;
    min-height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
}
.style-huawei #peek-dial-screen [data-i18n="add_number"] {
    display: none;
}
.style-huawei #peek-dial-screen > div:nth-child(2) {
    padding: 8px 40px 24px;
    row-gap: 10px;
    column-gap: 40px;
}
.style-huawei .dial-btn {
    background: transparent;
    border-radius: 0;
    width: 100%;
    height: 56px;
}
.style-huawei .dial-btn .sub {
    font-size: 11px;
    letter-spacing: 1px;
    color: #666666;
}
.style-huawei .dial-btn:nth-child(14) {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    background: #28c76f;
    margin: 4px auto 0;
}
.style-huawei .dial-btn:nth-child(14) .icon {
    width: 30px;
    height: 30px;
}
.style-huawei #peek-dial-del {
    width: 56px;
    height: 40px;
    border-radius: 12px;
    background: #f5f5f5;
    border: 1px solid #e0e0e0;
    margin: 12px auto 0;
}
.style-huawei #peek-dial-del .icon {
    fill: #666666;
    width: 24px;
    height: 24px;
}
.style-huawei #peek-dial-screen > div:last-child {
    background: #ffffff;
    border-top: 1px solid #e5e5e5;
}
.style-huawei #peek-dial-screen > div:last-child > div span {
    font-size: 11px;
    color: #666666;
}
.style-huawei #peek-dial-screen > div:last-child > div:first-child {
    color: #007dff;
}
.style-xiaomi #peek-dial-screen {
    background: #f6f6f6 !important;
}
.style-xiaomi #peek-dial-screen > div:first-child {
    align-items: flex-start;
    justify-content: flex-start;
    padding: 32px 24px 8px;
}
.style-xiaomi #peek-dial-num {
    font-size: 34px;
    color: #1b73e8 !important;
    font-weight: 400;
    text-align: center;
    width: 100%;
    margin-top: 24px;
    margin-bottom: 0 !important;
    min-height: 60px !important;
    display: flex;
    align-items: center;
    justify-content: center;
}
.style-xiaomi #peek-dial-screen [data-i18n="add_number"] {
    display: none;
}
.style-xiaomi #peek-dial-screen > div:nth-child(2) {
    padding: 4px 40px 24px;
    gap: 16px;
}
.style-xiaomi .dial-btn {
    width: 70px;
    height: 70px;
    border-radius: 50%;
    background: #f0f0f0;
}
.style-xiaomi .dial-btn:active {
    background: #d6d6d6;
}
.style-xiaomi .dial-btn .sub {
    font-size: 11px;
    letter-spacing: 1px;
    color: #666;
}
.style-xiaomi .dial-call-btn {
    width: 140px;
    height: 52px;
    border-radius: 26px;
    background: #18c059 !important;
    justify-self: center;
}
.style-xiaomi .dial-call-btn .icon {
    width: 26px;
    height: 26px;
}
.style-xiaomi #peek-dial-screen > div:last-child {
    background: #ffffff;
    border-top: 1px solid #e5e5e5;
}
.style-xiaomi #peek-dial-screen > div:last-child > div {
    color: #777777;
}
.style-xiaomi #peek-dial-screen > div:last-child > div span {
    font-size: 11px;
}
.style-xiaomi #peek-dial-screen > div:last-child > div:first-child {
    color: #1b73e8;
}
.style-xiaomi #peek-dial-screen > div:last-child > div:nth-child(2),
.style-xiaomi #peek-dial-screen > div:last-child > div:nth-child(4) {
    display: none;
}
.peek-dial-actions {
    font-size: 18px;
    line-height: 2;
    margin-bottom: 16px;
}
.peek-dial-action {
    color: #1b73e8;
    display: block;
    margin-bottom: 6px;
}
.style-xiaomi .peek-dial-actions {
    display: block !important;
    margin-top: 24px;
    margin-bottom: 20px;
}

/* --- Memo Overrides --- */
.style-android #peek-memo-screen,
.style-samsung #peek-memo-screen,
.style-huawei #peek-memo-screen,
.style-xiaomi #peek-memo-screen {
    background: #fff !important;
    color: #000;
}
.style-android #peek-memo-screen .icon,
.style-samsung #peek-memo-screen .icon {
    fill: #000 !important;
}
.style-android #peek-memo-screen div,
.style-samsung #peek-memo-screen div {
    color: #000 !important;
}

/* HarmonyOS-style Memo (Huawei & Android) */
.style-huawei #peek-memo-screen,
.style-xiaomi #peek-memo-screen {
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
}
.style-huawei #peek-memo-screen > div:first-child,
.style-xiaomi #peek-memo-screen > div:first-child {
    padding: 8px 16px 6px !important;
    padding-top: calc(8px + env(safe-area-inset-top)) !important;
    border-bottom: 0.5px solid #e5e5e5;
    color: #444;
    font-size: 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
}
.style-huawei #peek-memo-screen > div:first-child .icon,
.style-xiaomi #peek-memo-screen > div:first-child .icon {
    fill: #444 !important;
}
.style-huawei #peek-memo-screen > div:first-child span[data-i18n="peek_memo_nav_title"],
.style-xiaomi #peek-memo-screen > div:first-child span[data-i18n="peek_memo_nav_title"] {
    display: none;
}
.style-huawei #peek-memo-screen > div:nth-child(2),
.style-xiaomi #peek-memo-screen > div:nth-child(2) {
    padding: 14px 20px 4px !important;
}
.style-huawei #peek-memo-input,
.style-xiaomi #peek-memo-input {
    padding: 12px 20px 0 !important;
    font-size: 16px !important;
    line-height: 1.6;
    color: #000 !important;
}
.style-huawei #peek-memo-screen > div:last-child,
.style-xiaomi #peek-memo-screen > div:last-child {
    border-top: 0.5px solid #e5e5e5 !important;
    background: #fff !important;
    padding: 8px 30px 18px !important;
}
.style-huawei #peek-memo-screen > div:last-child .icon,
.style-xiaomi #peek-memo-screen > div:last-child .icon {
    fill: #222 !important;
}
.style-huawei #peek-memo-header-actions,
.style-xiaomi #peek-memo-header-actions {
    display: flex;
    align-items: center;
    gap: 18px;
    margin-left: 16px;
}
.style-huawei #peek-memo-header-actions .icon,
.style-xiaomi #peek-memo-header-actions .icon {
    width: 22px;
    height: 22px;
}
.style-huawei #peek-memo-title,
.style-xiaomi #peek-memo-title {
    width: 100%;
    border: none;
    outline: none;
    background: transparent;
    font-size: 28px;
    font-weight: 500;
    color: #222;
    padding: 0;
    margin: 0 0 4px 0;
}
.style-huawei #peek-memo-title::placeholder,
.style-xiaomi #peek-memo-title::placeholder {
    color: #b0b0b0;
}
.style-huawei #peek-memo-meta,
.style-xiaomi #peek-memo-meta {
    font-size: 12px;
    color: #8a8a8a;
}
.style-huawei #peek-memo-meta span,
.style-xiaomi #peek-memo-meta span {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 2px 10px;
    margin-left: 6px;
    border-radius: 14px;
    border: 0.5px solid #d0d0d0;
    font-size: 12px;
    color: #6a6a6a;
}
.style-huawei #peek-memo-footer,
.style-xiaomi #peek-memo-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 18px 18px !important;
}
.style-huawei #peek-memo-footer > div,
.style-xiaomi #peek-memo-footer > div {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
}
.style-huawei #peek-memo-footer .icon,
.style-xiaomi #peek-memo-footer .icon {
    width: 22px;
    height: 22px;
    fill: #222 !important;
}

/* HarmonyOS-style Passcode (PEEK) */
.style-huawei #peek-pass-screen {
    background: transparent !important;
    backdrop-filter: none !important;
    -webkit-backdrop-filter: none !important;
}
.style-huawei .lock-screen {
    justify-content: flex-start;
    padding-top: calc(18vh + env(safe-area-inset-top));
    background: transparent;
}
.style-huawei .pass-title {
    font-size: 18px;
    font-weight: 500;
    margin-bottom: 18px;
}
.style-huawei .pass-dots {
    margin-bottom: 32px;
}
.style-huawei .dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    border-width: 2px;
    margin: 0 8px;
}
.style-huawei .keypad {
    width: 70%;
    max-width: 320px;
    row-gap: 14px;
    column-gap: 14px;
}
.style-huawei .key-btn {
    width: auto;
    height: auto;
    border-radius: 0;
    background: transparent;
    box-shadow: none;
    padding: 6px 0;
}
.style-huawei .key-btn:active {
    background: rgba(255,255,255,0.08);
}
.style-huawei .key-num {
    font-size: 30px;
    line-height: 32px;
    font-weight: 400;
}
.style-huawei .key-sub {
    font-size: 11px;
    letter-spacing: 1px;
    margin-top: 2px;
}
.style-huawei .bottom-actions {
    bottom: 40px;
    width: 80%;
    font-size: 14px;
}
.style-huawei .action-btn {
    font-size: 14px;
    font-weight: 500;
}

/* Android/Xiaomi-style Passcode (PEEK) */
.style-xiaomi #peek-pass-screen {
    background: transparent !important;
    backdrop-filter: none !important;
    -webkit-backdrop-filter: none !important;
}
.style-xiaomi .lock-screen {
    justify-content: flex-start;
    padding-top: calc(18vh + env(safe-area-inset-top));
    background: transparent;
}
.style-xiaomi .pass-title {
    font-size: 18px;
    font-weight: 400;
    margin-bottom: 22px;
}
.style-xiaomi .pass-dots {
    margin-bottom: 36px;
}
.style-xiaomi .dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    border-width: 2px;
    margin: 0 10px;
}
.style-xiaomi .keypad {
    width: 72%;
    max-width: 320px;
    row-gap: 18px;
    column-gap: 18px;
}
.style-xiaomi .key-btn {
    width: auto;
    height: auto;
    border-radius: 0;
    background: transparent;
    box-shadow: none;
    padding: 6px 0;
}
.style-xiaomi .key-btn:active {
    background: rgba(255,255,255,0.08);
}
.style-xiaomi .key-num {
    font-size: 32px;
    line-height: 34px;
    font-weight: 400;
}
.style-xiaomi .key-sub {
    font-size: 10px;
    letter-spacing: 1px;
    margin-top: 2px;
}
.style-xiaomi .bottom-actions {
    bottom: 40px;
    width: 80%;
    font-size: 14px;
}
.style-xiaomi .action-btn {
    font-size: 14px;
    font-weight: 500;
}

/* --- Calculator Overrides --- */
.style-android #peek-calc-screen,
.style-samsung #peek-calc-screen {
    background: #fff !important;
}
.style-android #peek-calc-display,
.style-samsung #peek-calc-display {
    color: #000 !important;
}
.style-android .calc-btn,
.style-samsung .calc-btn {
    border-radius: 50%; /* Or rounded rect */
    color: #000;
    background: #f0f0f0;
}
.style-android .calc-btn.orange,
.style-samsung .calc-btn.orange {
    background: #00E676; /* Green accent */
    color: #fff;
}
.style-xiaomi .calc-btn {
    border-radius: 18px;
}

/* --- Password Overrides --- */
/* Android often uses lines or different dots */
.style-android .pass-dot,
.style-samsung .pass-dot {
    border: 1px solid #fff;
    background: transparent;
}
.style-android .pass-dot.filled,
.style-samsung .pass-dot.filled {
    background: #fff;
}

/* Connection Lost UI */
#connection-lost-modal {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.8); z-index: 20000;
    display: none; align-items: center; justify-content: center;
}
#connection-lost-modal .modal-content {
    background: var(--surface); color: var(--text-color);
    padding: 24px; border-radius: 16px; width: 80%; max-width: 320px;
    text-align: center;
}
#connection-lost-modal h3 { margin: 0 0 12px; }
#connection-lost-modal p { margin: 0 0 24px; color: #8e8e93; font-size: 15px; }
#connection-lost-dot {
    position: fixed; top: 15px; left: 12px;
    width: 8px; height: 8px; background: #ff3b30;
    border-radius: 50%; z-index: 20000;
    display: none;
    box-shadow: 0 0 4px rgba(255, 59, 48, 0.5);
}
@supports (padding-top: env(safe-area-inset-top)) {
    #connection-lost-dot { top: calc(22px); }
}

.file-input-wrapper {
    background: #2c2c2e;
    border: 1px solid #3a3a3c;
    border-radius: 12px;
    padding: 12px;
    display: flex;
    align-items: center;
    gap: 16px;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
    overflow: hidden;
    justify-content: space-between;
    min-height: 120px;
}
.file-input-wrapper:active { background: #3a3a3c; transform: scale(0.99); }
.preview-img {
    width: 60px; height: 90px;
    object-fit: cover;
    border-radius: 6px;
    background: #1c1c1e;
    border: 1px solid #444;
}
.file-label-content {
    flex: 1;
    display: flex;
    align-items: center;
    gap: 10px;
    color: var(--primary);
    font-weight: 500;
    font-size: 16px;
}
.file-label-desc {
    font-size: 12px;
    color: #8e8e93;
    margin-top: 2px;
    font-weight: 400;
}

/* Fix for dark mode text visibility on non-performance screens */
#main-menu-view,
#settings-view,
#custom-editor-view,
#rf-editor-view,
#bt-editor-view {
    color: #fff !important;
    --text-color: #fff;
}

/* Ensure cards always have white text as they have dark backgrounds */
.card {
    color: #fff !important;
    --text-color: #fff;
}

/* Main title override */
#main-menu-view h1 {
    color: #fff !important;
}

/* PEEK Styles */
.dial-btn {
    width: 75px; height: 75px; border-radius: 50%; background: #e5e5e5;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    font-size: 30px; font-weight: 400; color: #000; cursor: pointer;
    transition: background 0.2s;
}
.dial-btn:active { background: #bbb; }
.dial-btn .sub { font-size: 10px; font-weight: 700; margin-top: -2px; letter-spacing: 2px; }

.calc-btn {
    width: 100%;
    border-radius: 50%;
    aspect-ratio: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 32px;
    font-weight: 500;
    cursor: pointer;
    transition: filter 0.2s;
}
.calc-btn:active { filter: brightness(1.3); }
.calc-btn.gray { background: #a5a5a5; color: #000; }
.calc-btn.orange { background: #ff9f0a; color: #fff; }
.calc-btn.dark { background: #333333; color: #fff; }
.calc-btn.span2 { grid-column: span 2; aspect-ratio: auto; justify-content: flex-start; padding-left: 30px; }
.calc-btn.flash { filter: brightness(1.3); }
.calc-op.op-active { background: #fff; color: #ff9f0a; }
.calc-btn.sci { display: none; }
.calc-btn[data-key="00"] { display: none; }

.style-ios #peek-calc-screen {
    background: #000 !important;
}
.style-ios #peek-calc-display {
    color: #fff !important;
    background: transparent;
    padding: 20px;
    font-size: 80px;
    font-weight: 300;
}
.style-ios .peek-calc-keys {
    padding: 12px;
    gap: 12px;
    grid-template-columns: repeat(4, 1fr);
    padding-bottom: calc(30px + env(safe-area-inset-bottom));
}
.style-ios .calc-btn {
    border-radius: 50%;
    background: #333333;
    color: #fff;
}
.style-ios .calc-btn.gray {
    background: #a5a5a5;
    color: #000;
}
.style-ios .calc-btn.orange {
    background: #ff9f0a;
    color: #fff;
}
.style-ios .calc-op.op-active {
    background: #fff;
    color: #ff9f0a;
}
.style-ios .calc-btn.calc-op {
    background: #ff9f0a;
    color: #fff;
}
.style-ios .calc-btn.mem,
.style-ios .calc-btn.sci,
.style-ios .calc-btn[data-key="del"] {
    display: none;
}
.style-ios .calc-btn.span2 {
    grid-column: span 2;
    aspect-ratio: auto;
    justify-content: flex-start;
    padding-left: 30px;
}
.style-ios .calc-btn.zero {
    border-radius: 40px;
}
.style-ios .calc-btn[data-key="C"] {
    grid-row: 1;
    grid-column: 1;
}
.style-ios .calc-btn[data-key="neg"] {
    grid-row: 1;
    grid-column: 2;
}
.style-ios .calc-btn[data-key="%"] {
    grid-row: 1;
    grid-column: 3;
    background: #a5a5a5;
    color: #000;
}
.style-ios .calc-btn[data-key="/"] {
    grid-row: 1;
    grid-column: 4;
}
.style-ios .calc-btn[data-key="7"] {
    grid-row: 2;
    grid-column: 1;
}
.style-ios .calc-btn[data-key="8"] {
    grid-row: 2;
    grid-column: 2;
}
.style-ios .calc-btn[data-key="9"] {
    grid-row: 2;
    grid-column: 3;
}
.style-ios .calc-btn[data-key="x"] {
    grid-row: 2;
    grid-column: 4;
}
.style-ios .calc-btn[data-key="4"] {
    grid-row: 3;
    grid-column: 1;
}
.style-ios .calc-btn[data-key="5"] {
    grid-row: 3;
    grid-column: 2;
}
.style-ios .calc-btn[data-key="6"] {
    grid-row: 3;
    grid-column: 3;
}
.style-ios .calc-btn[data-key="-"] {
    grid-row: 3;
    grid-column: 4;
}
.style-ios .calc-btn[data-key="1"] {
    grid-row: 4;
    grid-column: 1;
}
.style-ios .calc-btn[data-key="2"] {
    grid-row: 4;
    grid-column: 2;
}
.style-ios .calc-btn[data-key="3"] {
    grid-row: 4;
    grid-column: 3;
}
.style-ios .calc-btn[data-key="+"] {
    grid-row: 4;
    grid-column: 4;
}
.style-ios .calc-btn.zero {
    grid-row: 5;
    grid-column: 1 / span 2;
}
.style-ios .calc-btn[data-key="."] {
    grid-row: 5;
    grid-column: 3;
}
.style-ios .calc-btn[data-key="="] {
    grid-row: 5;
    grid-column: 4;
}

/* Huawei Calculator Style */
.style-huawei #peek-calc-screen {
    background: #f5f6fb !important;
    justify-content: flex-end;
}
.style-huawei #peek-calc-display {
    color: #111827 !important;
    background: transparent;
    padding: 26px 20px 6px;
    font-weight: 500;
    flex: 0 0 auto !important;
}
.style-huawei .peek-calc-keys {
    padding: 8px 16px 26px;
    gap: 8px;
    grid-template-columns: repeat(4, 1fr);
    grid-auto-rows: 56px;
    flex: 0 0 auto;
}
.style-huawei .calc-btn {
    border-radius: 16px;
    background: #ffffff;
    color: #111827;
    font-size: 24px;
    box-shadow: 0 4px 10px rgba(15, 23, 42, 0.06);
    border: 1px solid #e2e8f0;
    aspect-ratio: auto;
}
.style-huawei .calc-btn.gray {
    background: #e5e9f2;
    color: #4b5563;
    border-color: #d0d7e6;
}
.style-huawei .calc-btn.dark {
    background: #ffffff;
    color: #111827;
}
.style-huawei .calc-btn.calc-op {
    background: #e5f0ff;
    color: #2563eb;
    border-color: #c7ddff;
}
.style-huawei .calc-btn.mem {
    background: transparent;
    border-color: transparent;
    box-shadow: none;
    color: #4b5563;
    font-size: 16px;
    font-weight: 500;
}
.style-huawei .calc-btn[data-key="="] {
    background: #2563eb;
    color: #ffffff;
    border-color: #2563eb;
}
.style-huawei .calc-op.op-active {
    background: #2563eb;
    color: #ffffff;
}
.style-huawei .calc-btn.span2 {
    grid-column: span 1;
    justify-content: center;
    padding-left: 0;
}
.style-huawei .calc-btn.eq-span2 {
    grid-row: span 2;
    height: auto;
    align-self: stretch;
}
.style-huawei .calc-btn.zero {
    border-radius: 16px;
}
.style-huawei .calc-btn[data-key="%"] {
    grid-column: 1;
    grid-row: 6;
}
.style-huawei .calc-btn.zero {
    grid-column: 2;
    grid-row: 6;
}
.style-huawei .calc-btn[data-key="."] {
    grid-column: 3;
    grid-row: 6;
}

/* Xiaomi Calculator Style */
.style-xiaomi #peek-calc-screen {
    background: #f5f5f5 !important;
    justify-content: flex-end;
}
.style-xiaomi #peek-calc-display {
    color: #111827 !important;
    background: transparent;
    padding: 26px 20px 10px;
    font-weight: 500;
    flex: 0 0 auto !important;
}
.style-xiaomi .peek-calc-keys {
    padding: 8px 16px 26px;
    gap: 10px;
    grid-template-columns: repeat(4, 1fr);
    grid-auto-rows: 60px;
    flex: 0 0 auto;
}
.style-xiaomi .calc-btn {
    background: #ffffff;
    color: #111827;
    font-size: 24px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.04);
    border: none;
    aspect-ratio: auto;
}
.style-xiaomi .calc-btn.dark {
    background: #ffffff;
    color: #111827;
}
.style-xiaomi .calc-btn.gray,
.style-xiaomi .calc-btn.calc-op {
    background: #ffffff;
    color: #ff8a00;
}
.style-xiaomi .calc-btn[data-key="="] {
    background: #ff8a00;
    color: #ffffff;
}
.style-xiaomi .calc-btn.mem {
    display: none;
}
.style-xiaomi .calc-btn.span2 {
    grid-column: span 1;
}
.style-xiaomi .calc-btn[data-key="C"] {
    grid-row: 1;
    grid-column: 1;
}
.style-xiaomi .calc-btn[data-key="del"] {
    grid-row: 1;
    grid-column: 2;
}
.style-xiaomi .calc-btn[data-key="%"] {
    grid-row: 1;
    grid-column: 3;
    color: #ff8a00;
}
.style-xiaomi .calc-btn[data-key="/"] {
    grid-row: 1;
    grid-column: 4;
}
.style-xiaomi .calc-btn[data-key="7"] {
    grid-row: 2;
    grid-column: 1;
}
.style-xiaomi .calc-btn[data-key="8"] {
    grid-row: 2;
    grid-column: 2;
}
.style-xiaomi .calc-btn[data-key="9"] {
    grid-row: 2;
    grid-column: 3;
}
.style-xiaomi .calc-btn[data-key="x"] {
    grid-row: 2;
    grid-column: 4;
}
.style-xiaomi .calc-btn[data-key="4"] {
    grid-row: 3;
    grid-column: 1;
}
.style-xiaomi .calc-btn[data-key="5"] {
    grid-row: 3;
    grid-column: 2;
}
.style-xiaomi .calc-btn[data-key="6"] {
    grid-row: 3;
    grid-column: 3;
}
.style-xiaomi .calc-btn[data-key="-"] {
    grid-row: 3;
    grid-column: 4;
}
.style-xiaomi .calc-btn[data-key="1"] {
    grid-row: 4;
    grid-column: 1;
}
.style-xiaomi .calc-btn[data-key="2"] {
    grid-row: 4;
    grid-column: 2;
}
.style-xiaomi .calc-btn[data-key="3"] {
    grid-row: 4;
    grid-column: 3;
}
.style-xiaomi .calc-btn[data-key="+"] {
    grid-row: 4;
    grid-column: 4;
}
.style-xiaomi .calc-btn.sci {
    display: flex;
    grid-row: 5;
    grid-column: 1;
}
.style-xiaomi .calc-btn.zero {
    grid-row: 5;
    grid-column: 2;
}
.style-xiaomi .calc-btn[data-key="."] {
    grid-row: 5;
    grid-column: 3;
}
.style-xiaomi .calc-btn[data-key="="] {
    grid-row: 5;
    grid-column: 4;
}
.style-xiaomi .calc-btn[data-key="neg"] {
    display: none;
}
.style-huawei .calc-btn[data-key="neg"] {
    display: none;
}

/* Bigger delete icon for HarmonyOS / Android calculator styles */
.style-huawei .calc-btn[data-key="del"],
.style-android .calc-btn[data-key="del"],
.style-samsung .calc-btn[data-key="del"],
.style-xiaomi .calc-btn[data-key="del"],
.style-vivo .calc-btn[data-key="del"] {
    font-size: 30px;
}

/* Bigger bottom-left icon (sci) in Android/Xiaomi calculator */
.style-xiaomi .calc-btn.sci .icon {
    width: 26px;
    height: 26px;
}

/* Vivo Calculator Style */
.style-vivo #peek-calc-screen {
    background: #ffffff !important;
    justify-content: flex-end;
}
.style-vivo #peek-calc-display {
    color: #222222 !important;
    background: transparent;
    padding: 26px 20px 10px;
    font-weight: 500;
    flex: 0 0 auto !important;
}
.style-vivo .peek-calc-keys {
    padding: 8px 20px 26px;
    gap: 12px;
    grid-template-columns: repeat(4, 1fr);
    grid-auto-rows: 64px;
    flex: 0 0 auto;
}
.style-vivo .calc-btn {
    border-radius: 999px;
    background: #f7f7f7;
    color: #333333;
    font-size: 24px;
    box-shadow: none;
    border: none;
    aspect-ratio: 1;
}
.style-vivo .calc-btn.gray,
.style-vivo .calc-btn.calc-op {
    background: #ffecec;
    color: #ff5b5b;
}
.style-vivo .calc-btn[data-key="="] {
    background: #ff5b5b;
    color: #ffffff;
    grid-row: 4 / span 2;
    grid-column: 4;
    border-radius: 999px;
}
.style-vivo .calc-btn.mem,
.style-vivo .calc-btn.sci,
.style-vivo .calc-btn[data-key="neg"],
.style-vivo .calc-btn[data-key="%"] {
    display: none;
}
.style-vivo .calc-btn.span2 {
    grid-column: span 1;
    justify-content: center;
    padding-left: 0;
    aspect-ratio: 1;
}
.style-vivo .calc-btn.zero {
    border-radius: 999px;
}
.style-vivo .calc-btn[data-key="C"] {
    grid-row: 1;
    grid-column: 1;
}
.style-vivo .calc-btn[data-key="del"] {
    grid-row: 1;
    grid-column: 2;
}
.style-vivo .calc-btn[data-key="x"] {
    grid-row: 1;
    grid-column: 3;
}
.style-vivo .calc-btn[data-key="/"] {
    grid-row: 1;
    grid-column: 4;
}
.style-vivo .calc-btn[data-key="7"] {
    grid-row: 2;
    grid-column: 1;
}
.style-vivo .calc-btn[data-key="8"] {
    grid-row: 2;
    grid-column: 2;
}
.style-vivo .calc-btn[data-key="9"] {
    grid-row: 2;
    grid-column: 3;
}
.style-vivo .calc-btn[data-key="-"] {
    grid-row: 2;
    grid-column: 4;
}
.style-vivo .calc-btn[data-key="4"] {
    grid-row: 3;
    grid-column: 1;
}
.style-vivo .calc-btn[data-key="5"] {
    grid-row: 3;
    grid-column: 2;
}
.style-vivo .calc-btn[data-key="6"] {
    grid-row: 3;
    grid-column: 3;
}
.style-vivo .calc-btn[data-key="+"] {
    grid-row: 3;
    grid-column: 4;
}
.style-vivo .calc-btn[data-key="1"] {
    grid-row: 4;
    grid-column: 1;
}
.style-vivo .calc-btn[data-key="2"] {
    grid-row: 4;
    grid-column: 2;
}
.style-vivo .calc-btn[data-key="3"] {
    grid-row: 4;
    grid-column: 3;
}
.style-vivo .calc-btn[data-key="00"] {
    display: flex;
    grid-row: 5;
    grid-column: 1;
}
.style-vivo .calc-btn.zero {
    grid-row: 5;
    grid-column: 2;
}
.style-vivo .calc-btn[data-key="."] {
    grid-row: 5;
    grid-column: 3;
}

#peek-calc-screen {
    display: flex;
    flex-direction: column;
}
#peek-calc-display {
    flex: 0.4 !important;
}
.peek-calc-keys {
    flex: 0.6;
}

.pass-dot {
    width: 16px; height: 16px; border-radius: 50%; border: 1px solid #fff;
    transition: background 0.2s;
}
.pass-dot.filled { background: #fff; }

</style>
</head>
<body>

<svg style="display:none">
  <symbol id="icon-back" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></symbol>
  <symbol id="icon-settings" viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 0 0 .12-.61l-1.92-3.32a.488.488 0 0 0-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 0 0-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58a.49.49 0 0 0-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.09.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></symbol>
  <symbol id="icon-wifi" viewBox="0 0 24 24"><path d="M1 9l2 2c4.97-4.97 13.03-4.97 18 0l2-2C16.93 2.93 7.08 2.93 1 9zm8 8l3 3 3-3c-1.66-1.66-4.34-1.66-6 0zm-4-4l2 2c2.76-2.76 7.24-2.76 10 0l2-2C15.14 9.14 8.87 9.14 5 13z"/></symbol>
  <symbol id="icon-signal" viewBox="0 0 24 24"><path d="M12.01 21.49L23.64 7c-.45-.34-4.93-4-11.64-4C5.28 3 .81 6.66.36 7l11.63 14.49.01.01.01-.01z"/></symbol>
  <symbol id="icon-lock" viewBox="0 0 24 24"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/></symbol>
  <symbol id="icon-info" viewBox="0 0 24 24"><path d="M11 17h2v-6h-2v6zm1-15C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v2h-2V7z"/></symbol>
  <symbol id="icon-flashlight" viewBox="0 0 24 24"><path d="M6 2h12v3H6zM6 7v8l6 6 6-6V7z"/></symbol>
  <symbol id="icon-camera" viewBox="0 0 24 24"><path d="M9.4 5l-1.6 1.8H4v11.4h16V6.8h-3.8l-1.6-1.8H9.4zM12 15c-1.9 0-3.5-1.6-3.5-3.5S10.1 8 12 8s3.5 1.6 3.5 3.5S13.9 15 12 15z"/></symbol>
  <symbol id="icon-battery" viewBox="0 0 24 24"><path d="M15.67 4H14V2h-4v2H8.33C7.6 4 7 4.6 7 5.33v15.33C7 21.4 7.6 22 8.33 22h7.33c.74 0 1.34-.6 1.34-1.33V5.33C17 4.6 16.4 4 15.67 4z"/></symbol>
  <symbol id="icon-scan" viewBox="0 0 24 24"><path d="M3 5v4h2V5h4V3H5c-1.1 0-2 .9-2 2zm2 10H3v4c0 1.1.9 2 2 2h4v-2H5v-4zm14 4h-4v2h4c1.1 0 2-.9 2-2v-4h-2v4zm0-16h-4v2h4v4h2V5c0-1.1-.9-2-2-2z"/></symbol>
  <symbol id="icon-more" viewBox="0 0 24 24"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></symbol>
  <symbol id="icon-check" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></symbol>
  <symbol id="icon-arrow-right" viewBox="0 0 24 24"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/></symbol>
  <symbol id="icon-chevron-right" viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></symbol>
  <symbol id="icon-plus" viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></symbol>
  <symbol id="icon-x" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></symbol>
  <symbol id="icon-trash" viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></symbol>
  <symbol id="icon-bluetooth" viewBox="0 0 24 24"><path d="M17.71 7.71L12 2h-1v7.59L6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 11 14.41V22h1l5.71-5.71-4.3-4.29 4.3-4.29zM13 5.83l1.88 1.88L13 9.59V5.83zm1.88 10.46L13 18.17v-3.76l1.88 1.88z"/></symbol>
  <symbol id="icon-text" viewBox="0 0 24 24"><path d="M2.5 4v3h5v12h3V7h5V4h-13zm19 5h-9v3h3v7h3v-7h3V9z"/></symbol>
  <symbol id="icon-music" viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></symbol>
  <symbol id="icon-language" viewBox="0 0 24 24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zm6.93 6h-2.95c-.32-1.25-.78-2.45-1.38-3.56 1.84.63 3.37 1.91 4.33 3.56zM12 4.04c.83 1.2 1.48 2.53 1.91 3.96h-3.82c.43-1.43 1.08-2.76 1.91-3.96zM4.26 14C4.1 13.36 4 12.69 4 12s.1-1.36.26-2h3.38c-.08.66-.14 1.32-.14 2 0 .68.06 1.34.14 2H4.26zm.82 2h2.95c.32 1.25.78 2.45 1.38 3.56-1.84-.63-3.37-1.9-4.33-3.56zm2.95-8H5.08c.96-1.66 2.49-2.93 4.33-3.56C8.81 5.55 8.35 6.75 8.03 8zM12 19.96c-.83-1.2-1.48-2.53-1.91-3.96h3.82c-.43 1.43-1.08 2.76-1.91 3.96zM14.34 14H9.66c-.09-.66-.16-1.32-.16-2 0-.68.07-1.35.16-2h4.68c.09.65.16 1.32.16 2 0 .68-.07 1.34-.16 2zm.25 5.56c.6-1.11 1.06-2.31 1.38-3.56h2.95c-.96 1.65-2.49 2.93-4.33 3.56zM16.36 14c.08-.66.14-1.32.14-2 0-.68-.06-1.34-.14-2h3.38c.16.64.26 1.31.26 2s-.1 1.36-.26 2h-3.38z"/></symbol>
  <symbol id="icon-phone" viewBox="0 0 24 24"><path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/></symbol>
  <symbol id="icon-star" viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></symbol>
  <symbol id="icon-clock" viewBox="0 0 24 24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></symbol>
  <symbol id="icon-user" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></symbol>
  <symbol id="icon-dialpad" viewBox="0 0 24 24"><path d="M12 19c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zM6 1c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm12-8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm-6 0c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm6 6c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm-6 0c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm-6 6c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm6 0c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm6 0c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2z"/></symbol>
  <symbol id="icon-voicemail" viewBox="0 0 24 24"><path d="M18.5 6C15.46 6 13 8.46 13 11.5c0 1.33.47 2.55 1.26 3.5H9.74c.79-.95 1.26-2.17 1.26-3.5C11 8.46 8.54 6 5.5 6S0 8.46 0 11.5 2.46 17 5.5 17h13c3.04 0 5.5-2.46 5.5-5.5S21.54 6 18.5 6zm-13 9C3.57 15 2 13.43 2 11.5S3.57 8 5.5 8 9 9.57 9 11.5 7.43 15 5.5 15zm13 0c-1.93 0-3.5-1.57-3.5-3.5S16.57 8 18.5 8 22 9.57 22 11.5 20.43 15 18.5 15z"/></symbol>
  <symbol id="icon-pen" viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a1.003 1.003 0 0 0 0-1.42l-2.34-2.34a1.003 1.003 0 0 0-1.42 0l-1.83 1.83 3.75 3.75 1.84-1.82z"/></symbol>
  <symbol id="icon-compose" viewBox="0 0 24 24"><path d="M3 5v14c0 1.1.9 2 2 2h14v-2H5V5H3zm14 0V3H7v2h10zm-1 4h-3V8h3V6l4 3-4 3V9z"/></symbol>
  <symbol id="icon-sci" viewBox="0 0 24 24"><path d="M5 7h7v7H5zM12 10h7v7h-7z"/></symbol>
  <symbol id="icon-undo" viewBox="0 0 24 24"><path d="M12 5V2L7 7l5 5V9c3.31 0 6 2.69 6 6 0 1.05-.27 2.04-.74 2.9l1.46 1.46C18.54 18.07 19 16.58 19 15c0-4.42-3.58-8-7-8z"/></symbol>
  <symbol id="icon-redo" viewBox="0 0 24 24"><path d="M12 5c-3.42 0-7 3.58-7 8 0 1.58.46 3.07 1.28 4.36L7.74 15.9C7.27 15.04 7 14.05 7 13c0-3.31 2.69-6 6-6v3l5-5-5-5v3z"/></symbol>
  <symbol id="icon-memo-brush" viewBox="0 0 24 24"><path d="M7 16c-1.66 0-3 1.34-3 3 0 .55.45 1 1 1h6c0-2.21-1.79-4-4-4zm12.71-9.71l-3-3a.996.996 0 0 0-1.41 0L9 10.59V14h3.41l6.3-6.29a.996.996 0 0 0 0-1.42z"/></symbol>
  <symbol id="icon-memo-check" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1.5 13.09l-3.59-3.59L8.5 10l2 2 4.59-4.59L16.5 9l-6 6.09z"/></symbol>
  <symbol id="icon-memo-text" viewBox="0 0 24 24"><path d="M4 5v3h7v11h3V8h7V5H4z"/></symbol>
  <symbol id="icon-memo-image" viewBox="0 0 24 24"><path d="M21 5H3c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 12H3V7h18v10zm-3-9c-.83 0-1.5.67-1.5 1.5S17.17 11 18 11s1.5-.67 1.5-1.5S18.83 8 18 8zM5 17l3.5-4.5 2.5 3.01L14.5 12 19 17H5z"/></symbol>
  <symbol id="icon-memo-clip" viewBox="0 0 24 24"><path d="M16.5 6.5L9 14c-.78.78-.78 2.05 0 2.83s2.05.78 2.83 0L18.5 10c1.56-1.56 1.56-4.09 0-5.66s-4.1-1.56-5.66 0L6.7 10.44c-2.34 2.34-2.34 6.14 0 8.48s6.14 2.34 8.48 0l.71-.71-1.41-1.41-.71.71c-1.56 1.56-4.09 1.56-5.66 0s-1.56-4.09 0-5.66l6.14-6.14c.78-.78 2.05-.78 2.83 0s.78 2.05 0 2.83z"/></symbol>
  <symbol id="icon-memo-mic" viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5-3c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.42 2.72 6.23 6 6.72V21H9v2h6v-2h-2v-3.28c3.28-.49 6-3.3 6-6.72h-2z"/></symbol>
</svg>

<div id="app">
  <!-- Main Menu View -->
  <div id="main-menu-view" class="view active">
    <div style="position: fixed; top: calc(20px + env(safe-area-inset-top)); right: 20px; z-index: 100; display:flex; gap:10px;">
        <button onclick="openHotspotSettingsModal()" style="background:rgba(80,80,80,0.8); border:none; width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; backdrop-filter:blur(10px); box-shadow: 0 2px 8px rgba(0,0,0,0.3);">
            <svg class="icon" style="width:24px; height:24px; fill:#fff"><use href="#icon-settings"></use></svg>
        </button>
        <button onclick="toggleLang()" style="background:rgba(80,80,80,0.8); border:none; width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; backdrop-filter:blur(10px); box-shadow: 0 2px 8px rgba(0,0,0,0.3);">
            <svg class="icon" style="width:24px; height:24px; fill:#fff"><use href="#icon-language"></use></svg>
        </button>
    </div>
    <div style="padding: 20px; padding-top: calc(40px + env(safe-area-inset-top)); display: flex; flex-direction: column; height: 100%; justify-content: center;">
      <h1 style="text-align:center; margin-bottom:40px; font-weight:300; letter-spacing:2px">Magic Control</h1>
      
      <div id="card-rf" class="card" onclick="openRfEditor()" style="cursor:pointer; display:flex; align-items:center; gap:15px">
          <svg class="icon" style="width:30px;height:30px;fill:var(--primary)"><use href="#icon-settings"></use></svg>
          <div>
            <h2 style="margin:0; font-size:18px" data-i18n="rf_editor">RF Editor</h2>
            <div style="color:#888; font-size:14px; margin-top:4px" data-i18n="rf_editor_desc">Edit RF devices and flows</div>
          </div>
      </div>

      <div id="card-abs" class="card" onclick="openAbsControl()" style="cursor:pointer; display:flex; align-items:center; gap:15px">
          <svg class="icon" style="width:30px;height:30px;fill:var(--primary)"><use href="#icon-bluetooth"></use></svg>
          <div>
            <h2 style="margin:0; font-size:18px" data-i18n="bt_routines">Abs Control</h2>
            <div style="color:#888; font-size:14px; margin-top:4px" data-i18n="bt_routines_desc">Edit ultimate  control flows</div>
          </div>
      </div>

      <div id="card-wifi" class="card" onclick="openWifiSettings()" style="cursor:pointer; display:flex; align-items:center; gap:15px">
          <svg class="icon" style="width:30px;height:30px;fill:var(--primary)"><use href="#icon-wifi"></use></svg>
          <div>
            <h2 style="margin:0; font-size:18px" data-i18n="wifi_settings">WiFi Settings</h2>
            <div style="color:#888; font-size:14px; margin-top:4px" data-i18n="wifi_settings_desc">Interference mode settings</div>
          </div>
      </div>

      <div id="card-peek" class="card" onclick="openPeekSettings()" style="cursor:pointer; display:flex; align-items:center; gap:15px">
          <svg class="icon" style="width:30px;height:30px;fill:var(--primary)"><use href="#icon-text"></use></svg>
          <div>
            <h2 style="margin:0; font-size:18px" data-i18n="peek_mode">PEEK Mode</h2>
            <div style="color:#888; font-size:14px; margin-top:4px" data-i18n="peek_mode_desc">Screen sync simulation</div>
          </div>
      </div>
    </div>
  </div>

  <!-- Settings View -->
  <div id="settings-view" class="view">
    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px">
          <h2 style="margin:0" data-i18n="settings_title">Settings</h2>
          <button class="btn" style="width:auto; padding:8px 16px; background:#333" onclick="closeSettings()" data-i18n="back_to_menu">Back</button>
      </div>
      
      <!-- AP Config -->
      <div class="form-group">
        <label data-i18n="ap_prefix">AP Name Prefix</label>
        <input type="text" id="ap-prefix" maxlength="10">
      </div>
      <div class="form-group">
        <label data-i18n="ap_suffix">WIFI Suffix</label>
        <input type="text" id="ap-suffix" maxlength="10">
      </div>
      <div class="form-group">
        <label data-i18n="ap_count">AP Count (1-50)</label>
        <input type="number" id="ap-count" min="1" max="50">
      </div>
      <!-- Simulation Config -->
      <div class="form-group">
        <label data-i18n="sim_style">Simulation Style</label>
        <select id="sim-style">
          <option value="ios" selected>iOS</option>
          <option value="huawei">HarmonyOS</option>
          <option value="xiaomi">Android 1</option>
          <option value="vivo">Android 2</option>
          <option value="oppo">Android 3</option>
          <option value="samsung">Android 4</option>
        </select>
      </div>
      <div class="form-group">
        <label data-i18n="theme">Theme</label>
        <select id="theme-select">
          <option value="auto" data-i18n="theme_auto">Auto (System)</option>
          <option value="dark" data-i18n="theme_dark">Dark Mode</option>
          <option value="light" data-i18n="theme_light">Light Mode</option>
        </select>
      </div>
      <div class="form-group">
        <label data-i18n="input_mode">Input Mode</label>
        <select id="input-mode">
          <option value="poker" data-i18n="mode_poker">Poker</option>
          <option value="poker_wifi" data-i18n="mode_poker_wifi">Poker (WiFi Input)</option>
          <option value="number" data-i18n="mode_number">Number</option>
          <option value="zodiac" data-i18n="mode_zodiac">Zodiac</option>
          <option value="bday_long" data-i18n="mode_bday_long">Birthday (YYMMDD)</option>
          <option value="bday_short" data-i18n="mode_bday_short">Birthday (MMDD)</option>
          <option value="custom" data-i18n="mode_custom">Custom</option>
        </select>
      </div>
      
      <!-- Custom Content -->
      <div class="form-group" id="custom-content-group" style="display:none">
        <label data-i18n="custom_content">Custom Content</label>
        <button class="btn" onclick="openCustomEditor()" data-i18n="edit_custom" style="background:#444; margin-top:5px">Edit Content</button>
        <input type="hidden" id="custom-content">
      </div>
      
      <!-- Upload BG -->
      <div class="form-group">
        <label data-i18n="bg_upload">Lock Screen Background</label>
        <div class="file-input-wrapper" onclick="document.getElementById('bg-upload').click()">
            <div style="display:flex; flex-direction:column; justify-content:center; flex:1">
                <div class="file-label-content">
                    <svg class="icon"><use href="#icon-plus"></use></svg>
                    <span data-i18n="select_image">Select Image</span>
                </div>
                <div class="file-label-desc" data-i18n="image_desc">Tap to change wallpaper</div>
            </div>
            <img id="bg-thumbnail" src="/bg.jpg" class="preview-img" onerror="this.style.opacity=0" onload="this.style.opacity=1">
            <input type="file" id="bg-upload" accept="image/*" onchange="handleBgUpload()" style="display:none">
        </div>
      </div>

      <!-- Actions -->
      <button class="btn" onclick="saveConfig()" data-i18n="btn_save" style="margin-bottom:10px">Save Settings</button>
      <button class="btn" onclick="startPerformance()" data-i18n="btn_start" style="background:var(--danger)">Start Performance</button>
    </div>


  </div>

  <!-- PEEK Settings View -->
  <div id="peek-settings-view" class="view">
    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px">
          <h2 style="margin:0" data-i18n="peek_settings_title">PEEK Settings</h2>
          <button class="btn" style="width:auto; padding:8px 16px; background:#333" onclick="closePeekSettings()" data-i18n="back_to_menu">Back</button>
      </div>

      <!-- Content Config -->
      <div class="form-group">
        <label data-i18n="peek_content">Simulation Content</label>
        <select id="peek-content">
          <option value="1" data-i18n="content_dial">Dialer</option>
          <option value="2" data-i18n="content_memo">Memo</option>
          <option value="3" data-i18n="content_password">Password</option>
          <option value="4" data-i18n="content_calc">Calculator</option>
        </select>
      </div>
      
      <!-- Style Config -->
      <div class="form-group">
        <label data-i18n="sim_style">Simulation Style</label>
        <select id="peek-style"></select>
      </div>

      <!-- Wallpaper Config -->
      <div class="form-group">
        <label data-i18n="bg_upload">Wallpaper</label>
        <div class="file-input-wrapper" onclick="document.getElementById('peek-bg-upload').click()">
            <div style="display:flex; flex-direction:column; justify-content:center; flex:1">
                <div class="file-label-content">
                    <svg class="icon"><use href="#icon-plus"></use></svg>
                    <span data-i18n="select_image">Select Image</span>
                </div>
                <div class="file-label-desc" data-i18n="image_desc">Tap to change wallpaper</div>
            </div>
            <img id="peek-bg-thumbnail" src="/peek_bg.jpg" class="preview-img" onerror="this.style.opacity=0" onload="this.style.opacity=1">
            <input type="file" id="peek-bg-upload" accept="image/*" onchange="handlePeekBgUpload()" style="display:none">
        </div>
      </div>

      <!-- Actions -->
      <button class="btn" onclick="savePeekConfig()" data-i18n="btn_save" style="margin-bottom:10px">Save Settings</button>
      <button class="btn" onclick="startPeekPerformance()" data-i18n="btn_start" style="background:var(--danger)">Start Performance</button>
    </div>
  </div>

  <!-- Custom Editor View -->
  <div id="custom-editor-view" class="view">
    <div style="padding: 20px; padding-top: calc(20px + env(safe-area-inset-top));">
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px">
          <h2 style="margin:0" data-i18n="custom_editor_title">Custom Content Editor</h2>
          <button class="btn" style="width:auto; padding:8px 16px; background:#333" onclick="closeCustomEditor()" data-i18n="save">Save</button>
        </div>
        
        <div id="custom-list" style="margin-bottom:20px; display:flex; flex-direction:column; gap:10px">
           <!-- Populated by JS -->
        </div>

        <div style="display:flex; gap:10px">
            <input type="text" id="custom-item-input" data-i18n="item_placeholder" placeholder="Enter content..." style="flex:1; padding:12px; background:#2c2c2e; border:1px solid #3a3a3c; border-radius:8px; color:#fff">
            <button class="btn" style="width:auto; background:var(--primary)" onclick="addCustomItem()" data-i18n="add_item">Add</button>
        </div>
      </div>
    </div>
  </div>

  <!-- RF Editor View -->
  <div id="rf-editor-view" class="view">
    <div style="padding: 20px; padding-top: calc(20px + env(safe-area-inset-top));">
      <div class="card">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px">
              <h2 style="margin:0" data-i18n="rf_editor">RF Editor</h2>
              <button class="btn" style="width:auto; padding:8px 16px" onclick="closeRfEditor()" data-i18n="back_to_menu">Back</button>
          </div>

          <div style="display:flex; gap:10px; margin-bottom:20px">
              <button class="btn" onclick="showRfTab('devices')" data-i18n="devices">Devices</button>
              <button class="btn" onclick="showRfTab('routines')" data-i18n="routines">Routines</button>

          </div>

          <div id="tab-devices" class="rf-tab">
              <div id="device-list"></div>
          </div>

          <div id="tab-routines" class="rf-tab" style="display:none">
              <div class="form-group">
                  <label data-i18n="routine_select">Select Routine</label>
                  <select id="routine-select" onchange="loadRoutine(this.value)">
                      <option value="1" data-i18n="routine_1">Routine 1</option>
                      <option value="2" data-i18n="routine_2">Routine 2</option>
                      <option value="3" data-i18n="routine_3">Routine 3</option>
                      <option value="4" data-i18n="routine_4">Routine 4</option>
                      <option value="5" data-i18n="routine_5">Routine 5</option>
                  </select>
              </div>
              <div id="routine-steps"></div>
              <div class="form-group" style="margin-top:20px; border-top:1px solid #333; padding-top:10px">
                  <label data-i18n="add_step">Add New Step</label>
                  <select id="routine-add-device"></select>
                  <button class="btn" style="margin-top:10px" onclick="addRoutineStep()" data-i18n="add_step">Add Step</button>
              </div>
          </div>


      </div>
    </div>
  </div>

  <!-- Absolute Control View -->
  <div id="bt-editor-view" class="view">
    <div style="padding: 20px; padding-top: calc(20px + env(safe-area-inset-top));">
      <div class="card">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px">
              <h2 style="margin:0" data-i18n="bt_routines">Ultimate Control</h2>
              <button class="btn" style="width:auto; padding:8px 16px" onclick="closeAbsControl()" data-i18n="back_to_menu">Back</button>
          </div>

          <div id="bt-routine-list" style="padding-bottom:100px"></div>
          
          <div style="position:fixed; bottom:30px; left:50%; transform:translateX(-50%); z-index:90">
              <button class="btn" style="background:var(--primary); box-shadow:0 4px 12px rgba(0,0,0,0.5); padding:12px 24px; border-radius:24px; width:auto; display:flex; align-items:center; gap:8px" onclick="openAddStepModal()">
                  <svg class="icon" style="width:20px;height:20px"><use href="#icon-plus"></use></svg>
                  <span data-i18n="add_step">Add Step</span>
              </button>
          </div>

          <!-- Add Step Modal -->
          <div id="add-step-modal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; align-items:center; justify-content:center">
              <div style="background:#1c1c1e; width:90%; max-width:500px; max-height:80vh; border-radius:12px; display:flex; flex-direction:column; overflow:hidden">
                  <div style="padding:16px; border-bottom:1px solid #333; display:flex; justify-content:space-between; align-items:center">
                      <h3 style="margin:0" data-i18n="add_step">Add Step</h3>
                      <button class="btn" style="width:auto; background:none; padding:4px; color:#fff" onclick="closeAddStepModal()">
                          <svg class="icon" style="width:24px;height:24px"><use href="#icon-x"></use></svg>
                      </button>
                  </div>
                  
                  <div style="display:flex; border-bottom:1px solid #333">
                      <div class="step-tab active" onclick="switchStepTab('bt')" style="flex:1; padding:12px; text-align:center; cursor:pointer; font-size:14px; color:var(--primary)" data-i18n="bluetooth"></div>
                      <div class="step-tab" onclick="switchStepTab('text')" style="flex:1; padding:12px; text-align:center; cursor:pointer; font-size:14px; color:#888" data-i18n="text"></div>
                      <div class="step-tab" onclick="switchStepTab('music')" style="flex:1; padding:12px; text-align:center; cursor:pointer; font-size:14px; color:#888" data-i18n="music"></div>
                      <div class="step-tab" onclick="switchStepTab('rf')" style="flex:1; padding:12px; text-align:center; cursor:pointer; font-size:14px; color:#888" data-i18n="rf"></div>
                  </div>
                  
                  <div id="step-content-bt" class="step-content" style="padding:16px; overflow-y:auto; display:grid; grid-template-columns:1fr 1fr; gap:10px">
                      <!-- Populated by JS -->
                  </div>
                  
                  <div id="step-content-text" class="step-content" style="padding:16px; display:none">
                      <input type="text" id="step-text-input" data-i18n="enter_text" placeholder="Enter text..." oninput="this.value = this.value.replace(/[^a-zA-Z0-9]/g, '')" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" inputmode="url" style="width:100%; padding:12px; background:#2c2c2e; border:none; border-radius:8px; color:#fff; margin-bottom:16px; box-sizing:border-box">
                      <label style="display:flex; align-items:center; gap:8px; margin-bottom:16px">
                          <input type="checkbox" id="step-text-enter"> <span data-i18n="auto_enter">Auto Enter</span>
                      </label>
                      <button class="btn" onclick="addTextStep()" data-i18n="add">Add</button>
                  </div>
                  
                  <div id="step-content-music" class="step-content" style="padding:16px; display:none; grid-template-columns:1fr 1fr 1fr; gap:10px">
                       <!-- Populated by JS -->
                  </div>
                  
                  <div id="step-content-rf" class="step-content" style="padding:16px; display:none">
                      <label data-i18n="select_device" style="display:block; margin-bottom:8px">Select Device</label>
                      <select id="step-rf-device" style="width:100%; padding:12px; background:#2c2c2e; border:none; border-radius:8px; color:#fff; margin-bottom:16px"></select>
                      
                      <div style="display:flex; gap:10px; margin-bottom:16px">
                          <div style="flex:1">
                              <label data-i18n="duration" style="display:block; margin-bottom:8px">Duration (s)</label>
                              <input type="number" id="step-rf-time" value="1" style="width:100%; padding:8px; background:#2c2c2e; border:none; border-radius:8px; color:#fff; box-sizing:border-box">
                          </div>
                          <div style="flex:1">
                              <label data-i18n="delay" style="display:block; margin-bottom:8px">Delay (s)</label>
                              <input type="number" id="step-rf-delay" value="0" style="width:100%; padding:8px; background:#2c2c2e; border:none; border-radius:8px; color:#fff; box-sizing:border-box">
                          </div>
                      </div>
                      <button class="btn" onclick="addRfStep()" data-i18n="add">Add</button>
                  </div>
              </div>
          </div>

      </div>
    </div>
  </div>

  <!-- Performance View -->
  <div id="performance-view" class="view">
    <!-- Real iOS Lock Screen -->
    <div id="ios-lock-screen" class="ios-lock-screen">
      <div class="status-bar">
      </div>
      <div class="lock-indicator">
         <svg class="icon icon-lock-filled" style="width:24px;height:24px"><use href="#icon-lock"></use></svg>
      </div>
      <div class="clock-area">
         <div class="time" id="clock-time">00:00</div>
         <div class="date" id="clock-date">11 </div>
         <div class="lunar" id="clock-lunar"></div>
      </div>
      <div class="bottom-shortcuts">
         <div class="shortcut-btn"><svg class="icon"><use href="#icon-flashlight"></use></svg></div>
         <div class="shortcut-btn"><svg class="icon"><use href="#icon-camera"></use></svg></div>
      </div>
      <div class="home-indicator"></div>
    </div>

    <!-- Lock Screen (Keypad) -->
    <div id="lock-screen" class="lock-screen" style="display:none">
      <div class="pass-title" data-i18n="enter_pass">Enter Passcode</div>
      <div class="pass-dots" id="pass-dots">
        <div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div>
      </div>
      <div class="keypad" id="keypad">
        <div class="key-btn" onclick="inputPass('1')"><div class="key-num">1</div><div class="key-sub"></div></div>
        <div class="key-btn" onclick="inputPass('2')"><div class="key-num">2</div><div class="key-sub">ABC</div></div>
        <div class="key-btn" onclick="inputPass('3')"><div class="key-num">3</div><div class="key-sub">DEF</div></div>
        <div class="key-btn" onclick="inputPass('4')"><div class="key-num">4</div><div class="key-sub">GHI</div></div>
        <div class="key-btn" onclick="inputPass('5')"><div class="key-num">5</div><div class="key-sub">JKL</div></div>
        <div class="key-btn" onclick="inputPass('6')"><div class="key-num">6</div><div class="key-sub">MNO</div></div>
        <div class="key-btn" onclick="inputPass('7')"><div class="key-num">7</div><div class="key-sub">PQRS</div></div>
        <div class="key-btn" onclick="inputPass('8')"><div class="key-num">8</div><div class="key-sub">TUV</div></div>
        <div class="key-btn" onclick="inputPass('9')"><div class="key-num">9</div><div class="key-sub">WXYZ</div></div>
        <div class="key-btn" style="background:none" onclick="inputPass('c')"></div>
        <div class="key-btn" onclick="inputPass('0')"><div class="key-num">0</div><div class="key-sub"></div></div>
        <div class="key-btn" style="background:none" onclick="inputPass('d')"></div>
      </div>
      
      <div class="bottom-actions">
        <button class="action-btn" data-i18n="emergency">Emergency</button>
        <button class="action-btn" data-i18n="cancel" onclick="exitPerformance()">Cancel</button>
      </div>
    </div>

    <!-- WiFi Screen -->
    <div id="wifi-screen" class="wifi-screen">
      <div id="quadrant-overlay" class="quadrant-overlay">
         <div class="quadrant q-tl" data-pos="tl"></div>
         <div class="quadrant q-tr" data-pos="tr"></div>
         <div class="quadrant q-bl" data-pos="bl"></div>
         <div class="quadrant q-br" data-pos="br"></div>
      </div>
      <div class="ios-header" id="wifi-header" onclick="handleHeaderClick()">
        <div class="header-btn" onclick="exitPerformance(); event.stopPropagation();">
          <svg class="icon" style="width:24px;height:24px;margin-left:-8px"><use href="#icon-back"></use></svg>
          <span data-i18n="settings">Settings</span>
        </div>
        <div class="header-title" data-i18n="wlan">WLAN</div>
        <div class="header-btn" style="opacity:0">Edit</div>
        <div class="header-icons-xiaomi" style="display:none; gap:16px; align-items:center;">
            <svg class="icon" style="width:24px;height:24px;fill:#000"><use href="#icon-scan"></use></svg>
            <svg class="icon" style="width:24px;height:24px;fill:#000"><use href="#icon-more"></use></svg>
        </div>
        <div class="header-icons-vivo" style="display:none; align-items:center;">
            <svg class="icon" style="width:24px;height:24px;fill:#000"><use href="#icon-scan"></use></svg>
        </div>
        <div class="header-icons-oppo" style="display:none; align-items:center; gap:16px">
            <svg class="icon" style="width:24px;height:24px;fill:#000"><use href="#icon-scan"></use></svg>
            <svg class="icon" style="width:24px;height:24px;fill:#000"><use href="#icon-more"></use></svg>
        </div>
        <div class="header-icons-samsung" style="display:none; gap:16px; align-items:center;">
            <svg class="icon" style="width:24px;height:24px;fill:currentColor"><use href="#icon-scan"></use></svg>
            <svg class="icon" style="width:24px;height:24px;fill:currentColor"><use href="#icon-more"></use></svg>
        </div>
      </div>
      
      <div class="wifi-content">
        <div class="group-container">
          <div class="list-row">
            <span data-i18n="wlan">WLAN</span>
            <div style="width:50px;height:30px;background:#34c759;border-radius:15px;position:relative" id="wlan-toggle">
               <div style="width:26px;height:26px;background:#fff;border-radius:50%;position:absolute;top:2px;right:2px;box-shadow:0 2px 4px rgba(0,0,0,0.2)"></div>
            </div>
          </div>
          <div class="list-row xiaomi-assistant" style="display:none; border-top: 1px solid #f0f0f0;">
             <span style="font-size:16px" data-i18n="wlan_assistant">WLAN </span>
             <svg class="icon" style="fill:#ccc"><use href="#icon-arrow-right"></use></svg>
          </div>
          <div class="list-row vivo-assistant" style="display:none; padding: 20px 0; border:none;">
             <div style="flex:1">
                 <div style="font-size:16px; margin-bottom:4px" data-i18n="network_assistant"></div>
                 <div style="font-size:12px; color:#999" data-i18n="network_acc_desc"></div>
             </div>
             <svg class="icon" style="fill:#ccc;width:16px;height:16px"><use href="#icon-chevron-right"></use></svg>
          </div>
          <div class="list-row oppo-assistant" style="display:none; padding: 16px 0; border-top: 1px solid #f5f5f5;">
             <span style="font-size:16px;font-weight:500" data-i18n="wlan_assistant">WLAN </span>
             <svg class="icon" style="fill:#ccc;width:16px;height:16px"><use href="#icon-chevron-right"></use></svg>
          </div>
        </div>

        <!-- Huawei Extras -->
        <div class="group-container huawei-extras" style="display:none">
            <div class="list-row">
                <span style="font-size:16px" data-i18n="network_acc"></span>
                <span style="color:#888;font-size:14px"><span data-i18n="closed"></span> &gt;</span>
            </div>
            <div class="list-row" style="border:none">
                <span style="font-size:16px" data-i18n="more_wlan_settings"> WLAN </span>
                <span style="color:#888;font-size:14px">&gt;</span>
            </div>
        </div>

        <div class="section-header">
          <span data-i18n="my_networks">MY NETWORKS</span>
        </div>
        <div class="group-container" id="my-networks">
            <div class="wifi-item" style="margin-left:16px;border:none">
                <div class="wifi-name" data-i18n="current_network">PhantomCharm_AP</div>
                <div class="wifi-icons">
                    <svg class="icon icon-lock"><use href="#icon-lock"></use></svg>
                    <svg class="icon icon-wifi"><use href="#icon-wifi"></use></svg>
                    <svg class="icon icon-info"><use href="#icon-info"></use></svg>
                </div>
            </div>
        </div>

        <div class="section-header">
          <span data-i18n="other_networks">OTHER NETWORKS</span>
          <div class="spinner"></div>
        </div>
        <div class="group-container" id="wifi-list" style="background:transparent; margin:0">
          <!-- Generated by JS -->
        </div>
      </div>
    </div>
    
    <!-- PEEK Screens -->
    <!-- Dialer -->
    <div id="peek-dial-screen" class="peek-screen" style="display:none; background:#fff; flex-direction:column; height:100%; width:100%; position:absolute; top:0; left:0; z-index:50">
        <div style="flex:1; display:flex; flex-direction:column; justify-content:center; align-items:center;">
             <div id="peek-dial-actions" class="peek-dial-actions" style="display:none; width:100%; max-width:360px; margin-bottom:16px;">
                 <div class="peek-dial-action" data-i18n="mi_new_contact"></div>
                 <div class="peek-dial-action" data-i18n="mi_add_to_contact"></div>
                 <div class="peek-dial-action" data-i18n="mi_video_call"></div>
                 <div class="peek-dial-action" data-i18n="mi_send_message"></div>
             </div>
             <div id="peek-dial-num" style="font-size:40px; font-weight:400; color:#000; margin-bottom:10px; min-height:50px"></div>
             <div style="font-size:14px; color:#007aff; margin-bottom:20px" data-i18n="add_number">Add Number</div>
        </div>
        <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:20px; padding:40px; padding-bottom:20px; justify-items:center;">
             <div class="dial-btn" onclick="peekDial('1')">1</div>
             <div class="dial-btn" onclick="peekDial('2')">2<div class="sub">ABC</div></div>
             <div class="dial-btn" onclick="peekDial('3')">3<div class="sub">DEF</div></div>
             <div class="dial-btn" onclick="peekDial('4')">4<div class="sub">GHI</div></div>
             <div class="dial-btn" onclick="peekDial('5')">5<div class="sub">JKL</div></div>
             <div class="dial-btn" onclick="peekDial('6')">6<div class="sub">MNO</div></div>
             <div class="dial-btn" onclick="peekDial('7')">7<div class="sub">PQRS</div></div>
             <div class="dial-btn" onclick="peekDial('8')">8<div class="sub">TUV</div></div>
             <div class="dial-btn" onclick="peekDial('9')">9<div class="sub">WXYZ</div></div>
             <div class="dial-btn" onclick="peekDial('*')">*</div>
             <div class="dial-btn" onclick="peekDial('0')">0<div class="sub">+</div></div>
             <div class="dial-btn" onclick="peekDial('#')">#</div>
             <div class="dial-btn" style="background:transparent"></div>
             <div class="dial-btn dial-call-btn" style="background:#4cd964; display:flex; align-items:center; justify-content:center" onclick="peekCall()">
                 <svg class="icon" style="fill:#fff; width:36px; height:36px"><use href="#icon-phone"></use></svg>
             </div>
            <div id="peek-dial-del" class="dial-btn" style="background:transparent; display:flex; align-items:center; justify-content:center" onclick="peekDialDel()">
                 <svg class="icon" style="fill:#ccc; width:30px; height:30px"><use href="#icon-x"></use></svg>
             </div>
        </div>
        
        <!-- Bottom Tab Bar -->
        <div style="display:flex; justify-content:space-around; align-items:center; padding:10px 0; padding-bottom:calc(10px + env(safe-area-inset-bottom)); background:rgba(255,255,255,0.9); backdrop-filter:blur(10px); border-top:0.5px solid #ccc">
             <div style="display:flex; flex-direction:column; align-items:center; color:#8e8e93">
                 <svg class="icon" style="width:26px; height:26px; fill:currentColor"><use href="#icon-star"></use></svg>
                 <span style="font-size:10px; margin-top:4px; font-weight:500" data-i18n="favorites">Favorites</span>
             </div>
             <div style="display:flex; flex-direction:column; align-items:center; color:#8e8e93">
                 <svg class="icon" style="width:26px; height:26px; fill:currentColor"><use href="#icon-clock"></use></svg>
                 <span style="font-size:10px; margin-top:4px; font-weight:500" data-i18n="recents">Recents</span>
             </div>
             <div style="display:flex; flex-direction:column; align-items:center; color:#8e8e93">
                 <svg class="icon" style="width:26px; height:26px; fill:currentColor"><use href="#icon-user"></use></svg>
                 <span style="font-size:10px; margin-top:4px; font-weight:500" data-i18n="contacts">Contacts</span>
             </div>
             <div style="display:flex; flex-direction:column; align-items:center; color:#007aff">
                 <svg class="icon" style="width:26px; height:26px; fill:currentColor"><use href="#icon-dialpad"></use></svg>
                 <span style="font-size:10px; margin-top:4px; font-weight:500" data-i18n="keypad">Keypad</span>
             </div>
             <div style="display:flex; flex-direction:column; align-items:center; color:#8e8e93">
                 <svg class="icon" style="width:26px; height:26px; fill:currentColor"><use href="#icon-voicemail"></use></svg>
                 <span style="font-size:10px; margin-top:4px; font-weight:500" data-i18n="voicemail">Voicemail</span>
             </div>
        </div>
    </div>

    <!-- Memo -->
    <div id="peek-memo-screen" class="peek-screen" style="display:none; background:#f2f2f7; flex-direction:column; height:100%; width:100%; position:absolute; top:0; left:0; z-index:50">
        <div style="padding:10px 16px; padding-top:calc(10px + env(safe-area-inset-top)); display:flex; justify-content:space-between; align-items:center; color:#e0a32e; font-size:17px">
            <div style="display:flex; align-items:center">
                <svg class="icon" style="fill:#e0a32e; width:20px; height:20px"><use href="#icon-back"></use></svg>
                <span style="margin-left:6px" data-i18n="peek_memo_nav_title"></span>
            </div>
            <div id="peek-memo-return" style="width:28px; height:28px; border-radius:50%; border:1.5px solid currentColor; display:flex; align-items:center; justify-content:center;">
                <div style="display:flex; align-items:center; justify-content:space-between; width:14px;">
                    <div style="width:3px; height:3px; border-radius:50%; background:currentColor"></div>
                    <div style="width:3px; height:3px; border-radius:50%; background:currentColor"></div>
                    <div style="width:3px; height:3px; border-radius:50%; background:currentColor"></div>
                </div>
            </div>
        </div>
        <div style="padding:10px 20px; font-size:34px; font-weight:700; color:#000"></div>
        <textarea id="peek-memo-input" style="flex:1; width:100%; background:transparent; border:none; padding:20px; font-size:18px; resize:none; outline:none; font-family:-apple-system, sans-serif" oninput="syncPeekMemo(this.value)"></textarea>
        <div style="flex-shrink:0; padding:10px 30px; padding-bottom:calc(10px + env(safe-area-inset-bottom)); display:flex; justify-content:space-between; align-items:center; color:#e0a32e; border-top:0.5px solid #e0e0e0; background:#f2f2f7">
            <div>
                <svg class="icon" style="width:24px; height:24px; fill:currentColor"><use href="#icon-check"></use></svg>
            </div>
            <div>
                <svg class="icon" style="width:26px; height:26px; fill:currentColor"><use href="#icon-camera"></use></svg>
            </div>
            <div>
                <svg class="icon" style="width:24px; height:24px; fill:currentColor"><use href="#icon-pen"></use></svg>
            </div>
            <div style="opacity:0.3">
                <svg class="icon" style="width:24px; height:24px; fill:currentColor"><use href="#icon-compose"></use></svg>
            </div>
        </div>
    </div>

    <!-- Calculator -->
    <div id="peek-calc-screen" class="peek-screen" style="display:none; background:#000; flex-direction:column; height:100%; width:100%; position:absolute; top:0; left:0; z-index:50">
            <div id="peek-calc-display" style="flex:1; display:flex; justify-content:flex-end; align-items:flex-end; font-size:80px; color:#fff; padding:20px; font-weight:300">0</div>
        <div class="peek-calc-keys" style="flex-shrink:0; display:grid; grid-template-columns:repeat(4, 1fr); gap:12px; padding:12px; padding-bottom:calc(30px + env(safe-area-inset-bottom));">
             <div class="calc-btn gray mem" data-key="MC">MC</div>
             <div class="calc-btn gray mem" data-key="M+">M+</div>
             <div class="calc-btn gray mem" data-key="M-">M-</div>
             <div class="calc-btn gray mem" data-key="MR">MR</div>
             
             <div id="peek-calc-ac" class="calc-btn gray" data-key="C" onclick="peekCalc('C')">C</div>
             <div class="calc-btn gray" data-key="neg" onclick="peekCalc('neg')"></div>
             <div class="calc-btn gray calc-op" data-key="/" data-op="/" onclick="peekCalc('/')"></div>
             <div class="calc-btn gray calc-op" data-key="x" data-op="x" onclick="peekCalc('x')"></div>
             <div class="calc-btn gray" data-key="del" onclick="peekCalcBackspace()"></div>
             
             <div class="calc-btn dark" data-key="7" onclick="peekCalc('7')">7</div>
             <div class="calc-btn dark" data-key="8" onclick="peekCalc('8')">8</div>
             <div class="calc-btn dark" data-key="9" onclick="peekCalc('9')">9</div>
             <div class="calc-btn calc-op dark" data-key="-" data-op="-" onclick="peekCalc('-')">-</div>
             
             <div class="calc-btn dark" data-key="4" onclick="peekCalc('4')">4</div>
             <div class="calc-btn dark" data-key="5" onclick="peekCalc('5')">5</div>
             <div class="calc-btn dark" data-key="6" onclick="peekCalc('6')">6</div>
             <div class="calc-btn calc-op dark" data-key="+" data-op="+" onclick="peekCalc('+')">+</div>
             
             <div class="calc-btn dark" data-key="1" onclick="peekCalc('1')">1</div>
             <div class="calc-btn dark" data-key="2" onclick="peekCalc('2')">2</div>
             <div class="calc-btn dark" data-key="3" onclick="peekCalc('3')">3</div>
             <div class="calc-btn orange eq-span2" data-key="=" onclick="peekCalc('=')">=</div>
             
             <div class="calc-btn dark sci" data-key="sci">
                 <svg class="icon" style="width:20px; height:20px; fill:#ff8a00"><use href="#icon-sci"></use></svg>
             </div>
             <div class="calc-btn dark" data-key="00" onclick="peekCalc('00')">00</div>
             <div class="calc-btn dark zero span2" style="aspect-ratio:auto" data-key="0" onclick="peekCalc('0')">0</div>
             <div class="calc-btn dark" data-key="%" onclick="peekCalc('%')">%</div>
             <div class="calc-btn dark" data-key="." onclick="peekCalc('.')">.</div>
        </div>
    </div>
    
    <!-- Password (PEEK) -->
    <div id="peek-pass-screen" class="peek-screen lock-screen" style="display:none; background:transparent; position:absolute; top:0; left:0; width:100%; height:100%; z-index:50; backdrop-filter:blur(20px); -webkit-backdrop-filter:blur(20px);">
      <div class="pass-title" data-i18n="enter_pass">Enter Passcode</div>
      <div class="pass-dots" id="peek-pass-dots">
        <div class="dot" id="pd-1"></div>
        <div class="dot" id="pd-2"></div>
        <div class="dot" id="pd-3"></div>
        <div class="dot" id="pd-4"></div>
        <div class="dot" id="pd-5"></div>
        <div class="dot" id="pd-6"></div>
      </div>
      <div class="keypad">
        <div class="key-btn" onclick="peekPass('1')"><div class="key-num">1</div><div class="key-sub"></div></div>
        <div class="key-btn" onclick="peekPass('2')"><div class="key-num">2</div><div class="key-sub">ABC</div></div>
        <div class="key-btn" onclick="peekPass('3')"><div class="key-num">3</div><div class="key-sub">DEF</div></div>
        <div class="key-btn" onclick="peekPass('4')"><div class="key-num">4</div><div class="key-sub">GHI</div></div>
        <div class="key-btn" onclick="peekPass('5')"><div class="key-num">5</div><div class="key-sub">JKL</div></div>
        <div class="key-btn" onclick="peekPass('6')"><div class="key-num">6</div><div class="key-sub">MNO</div></div>
        <div class="key-btn" onclick="peekPass('7')"><div class="key-num">7</div><div class="key-sub">PQRS</div></div>
        <div class="key-btn" onclick="peekPass('8')"><div class="key-num">8</div><div class="key-sub">TUV</div></div>
        <div class="key-btn" onclick="peekPass('9')"><div class="key-num">9</div><div class="key-sub">WXYZ</div></div>
        <div class="key-btn" style="background:none" onclick="peekPass('c')"></div>
        <div class="key-btn" onclick="peekPass('0')"><div class="key-num">0</div><div class="key-sub"></div></div>
        <div class="key-btn" style="background:none" onclick="peekPass('del')"></div>
      </div>
      <div class="bottom-actions">
        <button class="action-btn" data-i18n="emergency">Emergency</button>
        <button id="peek-pass-cancel" class="action-btn" data-i18n="cancel">Cancel</button>
      </div>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<!-- Connection Lost UI -->
<div id="connection-lost-dot"></div>
<div id="connection-lost-modal">
    <div class="modal-content">
        <h3 data-i18n="conn_lost_title">Connection Lost</h3>
        <p data-i18n="conn_lost_desc">Please check your connection to the device.</p>
        <button class="btn" onclick="retryConnection()" data-i18n="retry">Retry</button>
    </div>
</div>

<div id="hotspot-settings-modal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:20001; align-items:center; justify-content:center">
    <div style="background:#1c1c1e; width:90%; max-width:360px; border-radius:12px; padding:20px; box-sizing:border-box">
        <h3 style="margin:0 0 16px 0" data-i18n="wifi_settings">WiFi Settings</h3>
        <div class="form-group">
            <label data-i18n="hotspot_ssid">Hotspot SSID</label>
            <input type="text" id="hotspot-ssid" placeholder="MagicControl_AP">
        </div>
        <div class="form-group">
            <label data-i18n="hotspot_password">Hotspot Password</label>
            <input type="text" id="hotspot-password" placeholder="12345678">
        </div>
        <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:10px">
            <button class="btn" style="width:auto; background:#333" onclick="closeHotspotSettingsModal()" data-i18n="cancel">Cancel</button>
            <button class="btn" style="width:auto" onclick="saveHotspotSettings()" data-i18n="btn_save">Save Settings</button>
        </div>
    </div>
</div>

<script>
// State
const state = {
  config: {
    prefix: ".",
    count: 20,
    style: "ios",
    theme: "auto",
    mode: "number",
    home_mode: 0,
    custom: ""
  },
  lang: "zh",
  input: "",
  targetContent: "",
  isEmitting: false,
  isRevealed: false,
  realWifis: [],
  bgUrl: null,
  peekBgUrl: null,
  peekActive: false,
  peekPassLength: 6
};

let peekMemoOriginal = null;

const defaultGradient = "linear-gradient(180deg, #020617 0%, #0b1120 100%)";
const peekStyleOptions = {
  1: [
    { value: "ios", label: "iOS" },
    { value: "xiaomi", label: "Android" },
    { value: "huawei", label: "HarmonyOS" }
  ],
  2: [
    { value: "ios", label: "iOS" },
    { value: "xiaomi", label: "Android" },
    { value: "huawei", label: "HarmonyOS" }
  ],
  3: [
    { value: "ios", label: "iOS" },
    { value: "xiaomi", label: "Android" },
    { value: "huawei", label: "HarmonyOS" }
  ],
  4: [
    { value: "ios", label: "iOS" },
    { value: "xiaomi", label: "Android" },
    { value: "vivo", label: "Android II" },
    { value: "huawei", label: "HarmonyOS" }
  ]
};

// I18N
const dict = {
  en: {
    settings_title: "Magic Settings",
    ap_prefix: "AP Prefix",
    ap_count: "AP Count",
    sim_style: "Simulation Style",
    theme: "Theme",
    theme_auto: "Auto (System)",
    theme_dark: "Dark Mode",
    theme_light: "Light Mode",
    inputzodiac: "Zodiac",
    mode_bday_long: "Birthday (YYMMDD)",
    mode_bday_short: "Birthday (MMDD)",
    mode__mode: "Input Mode",
    mode_poker: "Poker",
    mode_poker_wifi: "Poker (WiFi)",
    mode_number: "Number",
    mode_custom: "Custom",
    custom_content: "Custom Content",
    edit_custom: "Edit Content",
    custom_editor_title: "Custom Content Editor",
    add_item: "Add Item",
    item_placeholder: "Enter content...",
    bg_upload: "Lock Screen Wallpaper",
    bluetooth: "Bluetooth",
    text: "Text Input",
    music: "Music Control",
    rf: "RF Device",
    enter_text: "Enter text...",
    auto_enter: "Auto Enter",
    add: "Add",
    select_device: "Select Device",
    duration: "Duration",
    delay: "Delay",
    select_image: "Select Image",
    image_desc: "Tap to change wallpaper",
    btn_upload: "Upload",
    btn_save: "Save Config",
    btn_start: "Start Performance",
    wlan: "WLAN",
    saved: "Saved!",
    upload_success: "Uploaded!",
    upload_fail: "Failed",
    enter_pass: "Enter Passcode",
    emergency: "Emergency",
    cancel: "Cancel",
    settings: "Settings",
    my_networks: "MY NETWORKS",
    other_networks: "OTHER NETWORKS",
    current_network: "PhantomCharm_AP",
    hotspot_ssid: "Hotspot SSID (Empty for Default)",
    hotspot_password: "Hotspot Password (Empty for Default)",
    connected_good_quality: "Connected (Good Quality)",
    refresh: "Refresh",
    add_network: "Add Network",
    advanced_settings: "Advanced Settings",
    connected_wlan: "Connected WLAN",
    available_wlan: "Available WLAN",
    saved_networks: "Saved Networks",
    available_networks: "Available Networks",
    current_network_samsung: "Current Network",
    available_networks_samsung: "Available Networks",
    connected: "Connected",
    no_internet: "No Internet Connection",
    connected_no_internet: "Connected without Internet",
    samsung_security_msg: "Secure. Click [Security Check] for details.",
    security_check: "Security Check",
    wlan_assistant: "WLAN Assistant",
    network_assistant: "Network Assistant",
    network_acc_desc: "Multi-network acceleration and switching",
    network_acc: "Network Acceleration",
    closed: "Off",
    more_wlan_settings: "More WLAN Settings",
    on: "On",
    encrypted: "Encrypted",
    open: "Open",
    searching: "Searching...",
    rf_editor: "RF Editor",
    devices: "Devices",
    routines: "Routines",
    bt_routines: "Ultimate Control",
    routine_select: "Select Routine",
    routine_1: "Routine 1",
    routine_2: "Routine 2",
    routine_3: "Routine 3",
    routine_4: "Routine 4",
    routine_5: "Routine 5",
    add_step: "Add Step",
    save: "Save",
    no_steps: "No steps added",
    device_name: "Device Name",
    rename: "Rename",
    rf_editor_desc: "Edit RF devices and routines",
    bt_routines_desc: "Edit ultimate control flows",
    wifi_settings: "WiFi Settings",
    wifi_settings_desc: "Interference mode settings",
    back_to_menu: "Back to Menu",
    conn_lost_title: "Connection Lost",
    conn_lost_desc: "Connection to device lost. Please check your WiFi settings.",
    retry: "Retry",
    peek_mode: "PEEK Mode",
    peek_mode_desc: "Screen sync simulation",
    peek_settings_title: "PEEK Settings",
    peek_content: "Simulation Content",
    content_dial: "Dialer",
    content_memo: "Memo",
    content_password: "Password",
    content_calc: "Calculator",
    add_number: "Add Number",
    favorites: "Favorites",
    recents: "Recents",
    contacts: "Contacts",
    keypad: "Keypad",
    voicemail: "Voicemail",
    mi_tab_call: "Call",
    mi_tab_contacts: "Contacts",
    mi_tab_service: "Services",
    hw_tab_phone: "Phone",
    hw_tab_contacts: "Contacts",
    hw_tab_favorites: "Favorites",
    hw_tab_link: "MeeTime",
    peek_memo_title: "Memo",
    peek_memo_nav_title: "Notes",
    memo_title_placeholder: "Title",
    mi_new_contact: "Create new contact",
    mi_add_to_contact: "Add to contacts",
    mi_video_call: "Start video call",
    mi_send_message: "Send message"
  },
  zh: {
    settings_title: "",
    ap_prefix: "WIFI",
    ap_suffix: "WIFI",
    mode_zodiac: "",
    mode_bday_long: "()",
    mode_bday_short: "()",
    mode_unt: "",
    ap_count: "WIFI",
    sim_style: "",
    theme: "",
    theme_auto: " ()",
    theme_dark: "",
    theme_light: "",
    input_mode: "",
    mode_poker: "",
    mode_poker_wifi: " (WiFi)",
    mode_number: "",
    mode_custom: "",
    custom_content: "",
    edit_custom: "",
    custom_editor_title: "",
    add_item: "",
    item_placeholder: "...",
    bg_upload: "",
    bluetooth: "",
    text: "",
    music: "",
    rf: "RF",
    enter_text: "...",
    auto_enter: "",
    add: "",
    select_device: "",
    duration: "",
    delay: "",
    select_image: "",
    image_desc: "",
    btn_upload: "",
    btn_save: "",
    btn_start: "",
    wlan: "",
    saved: "!",
    upload_success: "!",
    upload_fail: "",
    enter_pass: "",
    emergency: "",
    cancel: "",
    settings: "",
    my_networks: "",
    other_networks: "",
    current_network: "PhantomCharm_AP",
    hotspot_ssid: " ()",
    hotspot_password: " ()",
    connected_good_quality: " ()",
    refresh: "",
    add_network: "",
    advanced_settings: "",
    connected_wlan: " WLAN",
    available_wlan: " WLAN",
    saved_networks: "",
    available_networks: "",
    current_network_samsung: "",
    available_networks_samsung: "",
    connected: "",
    no_internet: "",
    connected_no_internet: "",
    samsung_security_msg: "",
    security_check: "",
    wlan_assistant: "WLAN ",
    network_assistant: "",
    network_acc_desc: "",
    network_acc: "",
    closed: "",
    more_wlan_settings: " WLAN ",
    on: "",
    encrypted: "",
    open: "",
    searching: "...",
    rf_editor: "RF ",
    devices: "",
    routines: "",
    bt_routines: "",
    routine_select: "",
    routine_1: " 1",
    routine_2: " 2",
    routine_3: " 3",
    routine_4: " 4",
    routine_5: " 5",
    add_step: "",
    save: "",
    no_steps: "",
    device_name: "",
    rename: "",
    rf_editor_desc: "RF",
    bt_routines_desc: "",
    wifi_settings: "WiFi",
    wifi_settings_desc: "",
    back_to_menu: "",
    conn_lost_title: "",
    conn_lost_desc: "",
    retry: "",
    peek_mode: "PEEK",
    peek_mode_desc: "",
    peek_settings_title: "PEEK",
    peek_content: "",
    content_dial: "",
    content_memo: "",
    content_password: "",
    content_calc: "",
    add_number: "",
    favorites: "",
    recents: "",
    contacts: "",
    keypad: "",
    voicemail: "",
    peek_memo_title: "",
    peek_memo_nav_title: "",
    memo_title_placeholder: "",
    mi_tab_call: "",
    mi_tab_contacts: "",
    mi_tab_service: "",
    hw_tab_phone: "",
    hw_tab_contacts: "",
    hw_tab_favorites: "",
    hw_tab_link: "",
    mi_new_contact: "",
    mi_add_to_contact: "",
    mi_video_call: "",
    mi_send_message: ""
  }
};

function addPeekLongPress(id, callback, duration) {
  const el = document.getElementById(id);
  if (!el) return;
  let timer = null;
  const start = () => {
    if (timer) clearTimeout(timer);
    timer = setTimeout(() => {
      timer = null;
      callback();
    }, duration || 2000);
  };
  const cancel = () => {
    if (timer) {
      clearTimeout(timer);
      timer = null;
    }
  };
  ['mousedown','touchstart'].forEach(evt => el.addEventListener(evt, start));
  ['mouseup','mouseleave','touchend','touchcancel'].forEach(evt => el.addEventListener(evt, cancel));
}

// Init
document.addEventListener("DOMContentLoaded", async () => {
  await loadConfig();
  updateUI();
  await updateWallpaper();
  
  setInterval(() => checkConnection(), 5000);
  
  document.body.addEventListener('dblclick', (e) => {
    if(e.clientY > window.innerHeight - 100) exitPerformance();
  });

  const memoScreen = document.getElementById('peek-memo-screen');
  if (memoScreen && memoScreen.children.length >= 3 && !peekMemoOriginal) {
    const header = memoScreen.children[0];
    const titleWrapper = memoScreen.children[1];
    const footer = memoScreen.lastElementChild;
    peekMemoOriginal = {
      headerHTML: header ? header.innerHTML : '',
      titleHTML: titleWrapper ? titleWrapper.innerHTML : '',
      footerHTML: footer ? footer.innerHTML : ''
    };
  }

  addPeekLongPress('peek-pass-cancel', exitPeekToSettings, 2000);
  addPeekLongPress('peek-dial-del', exitPeekToSettings, 2000);
  addPeekLongPress('peek-memo-return', exitPeekToSettings, 2000);
  addPeekLongPress('peek-calc-ac', exitPeekToSettings, 2000);

  const peekContentSelect = document.getElementById('peek-content');
  if (peekContentSelect) {
    peekContentSelect.addEventListener('change', () => {
      updatePeekStyleOptions();
    });
  }

  updatePeekStyleOptions(state.config.peek_style);
});

// API Calls
async function loadConfig() {
  try {
    const res = await fetch('/api/config');
    if(res.ok) {
      const data = await res.json();
      state.config = { ...state.config, ...data };
      document.getElementById('ap-prefix').value = state.config.prefix;
      document.getElementById('ap-suffix').value = state.config.suffix || "";
      document.getElementById('ap-count').value = state.config.count;
      document.getElementById('sim-style').value = state.config.style;
      document.getElementById('theme-select').value = state.config.theme || 'auto';
      document.getElementById('input-mode').value = state.config.mode;
      document.getElementById('custom-content').value = state.config.custom || "";
      document.getElementById('hotspot-ssid').value = state.config.hotspot_ssid || "";
      document.getElementById('hotspot-password').value = state.config.hotspot_password || "";
      
      // PEEK Config
      if(state.config.peek_content) document.getElementById('peek-content').value = state.config.peek_content;
      updatePeekStyleOptions(state.config.peek_style);
      
      updateCurrentNetworkName();
      updateHomeCards();
    }
  } catch(e) { console.error(e); }
}

async function saveConfig() {
  state.config.prefix = document.getElementById('ap-prefix').value;
  state.config.suffix = document.getElementById('ap-suffix').value;
  state.config.count = parseInt(document.getElementById('ap-count').value);
  state.config.style = document.getElementById('sim-style').value;
  state.config.theme = document.getElementById('theme-select').value;
  state.config.mode = document.getElementById('input-mode').value;
  state.config.custom = document.getElementById('custom-content').value;
  state.config.hotspot_ssid = document.getElementById('hotspot-ssid').value;
  state.config.hotspot_password = document.getElementById('hotspot-password').value;
  
  try {
    await fetch('/api/config', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(state.config)
    });
    showToast(t('saved'));
    updateCurrentNetworkName();
  } catch(e) { showToast("Error"); }
}

function openHotspotSettingsModal() {
  const modal = document.getElementById('hotspot-settings-modal');
  if (modal) modal.style.display = 'flex';
}

function closeHotspotSettingsModal() {
  const modal = document.getElementById('hotspot-settings-modal');
  if (modal) modal.style.display = 'none';
}

async function saveHotspotSettings() {
  const ssidInput = document.getElementById('hotspot-ssid');
  const passwordInput = document.getElementById('hotspot-password');
  if (!ssidInput || !passwordInput) return;
  state.config.hotspot_ssid = ssidInput.value;
  state.config.hotspot_password = passwordInput.value;
  try {
    await fetch('/api/config', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(state.config)
    });
    showToast(t('saved'));
    updateCurrentNetworkName();
    closeHotspotSettingsModal();
  } catch(e) { showToast("Error"); }
}

function updateCurrentNetworkName() {
  const ssid = state.config.hotspot_ssid;
  const currentNetworkEl = document.querySelector('.wifi-name[data-i18n="current_network"]') || document.querySelector('.wifi-name');
  
  // Find the specific element in MY NETWORKS
  const myNetworksContainer = document.getElementById('my-networks');
  if (myNetworksContainer) {
      const nameEl = myNetworksContainer.querySelector('.wifi-name');
      if (nameEl) {
        if (!ssid || ssid === "MagicControl_AP" || ssid.trim() === "") {
            // Generate random name if default
            // Use a consistent random name per session or random every time? 
            // User said: "randomly generate a name to replace it"
            const randomNames = ["iPhone", "Office_Guest", "Home_WiFi", "Starbucks_WiFi", "Meeting_Room", "Airport_Free_WiFi"];
            const randomName = randomNames[Math.floor(Math.random() * randomNames.length)];
            nameEl.textContent = randomName;
            nameEl.removeAttribute('data-i18n'); 
        } else {
            nameEl.textContent = ssid;
            nameEl.removeAttribute('data-i18n');
        }
      }
  }
}

// IndexedDB Helpers
const dbName = 'MagicControlDB';
const storeName = 'settings';

function openDB() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open(dbName, 1);
    request.onerror = () => reject('DB Error');
    request.onupgradeneeded = event => {
      const db = event.target.result;
      if (!db.objectStoreNames.contains(storeName)) {
        db.createObjectStore(storeName);
      }
    };
    request.onsuccess = event => resolve(event.target.result);
  });
}

async function saveWallpaper(file) {
  try {
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const transaction = db.transaction([storeName], 'readwrite');
      const store = transaction.objectStore(storeName);
      const request = store.put(file, 'wallpaper');
      request.onsuccess = () => resolve();
      request.onerror = () => reject();
    });
  } catch (e) { console.error(e); throw e; }
}

async function getWallpaper() {
  try {
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const transaction = db.transaction([storeName], 'readonly');
      const store = transaction.objectStore(storeName);
      const request = store.get('wallpaper');
      request.onsuccess = () => resolve(request.result);
      request.onerror = () => reject();
    });
  } catch (e) { return null; }
}

async function savePeekWallpaper(file) {
  try {
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const transaction = db.transaction([storeName], 'readwrite');
      const store = transaction.objectStore(storeName);
      const request = store.put(file, 'peek_wallpaper');
      request.onsuccess = () => resolve();
      request.onerror = () => reject();
    });
  } catch (e) { console.error(e); throw e; }
}

async function getPeekWallpaper() {
  try {
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const transaction = db.transaction([storeName], 'readonly');
      const store = transaction.objectStore(storeName);
      const request = store.get('peek_wallpaper');
      request.onsuccess = () => resolve(request.result);
      request.onerror = () => reject();
    });
  } catch (e) { return null; }
}

async function handleBgUpload() {
  const file = document.getElementById('bg-upload').files[0];
  if(!file) return;
  
  // Update thumbnail immediately
  const thumb = document.getElementById('bg-thumbnail');
  thumb.src = URL.createObjectURL(file);
  thumb.style.display = 'block';

  // Upload to Server
  const formData = new FormData();
  formData.append("data", file, "bg.jpg");

  try {
    const res = await fetch('/api/upload-bg', {
        method: 'POST',
        body: formData
    });
    
    if(res.ok) {
        // Also save locally for offline support
        await saveWallpaper(file);
        // Save other settings too as requested
        await saveConfig();
        showToast(t('saved'));
    } else {
        showToast(t('upload_fail'));
    }
  } catch(e) {
    console.error(e);
    // Fallback to local only if server fails?
    try {
        await saveWallpaper(file);
        showToast(t('saved') + " (Local)");
    } catch(err) {
        showToast(t('upload_fail'));
    }
  }
}

async function fetchRealWifi() {
  try {
    const res = await fetch('/api/wifi-list');
    if(res.ok) state.realWifis = await res.json();
    else state.realWifis = ["CMCC-5G", "ChinaNet", "TP-LINK_5G"];
  } catch(e) {
    state.realWifis = ["CMCC-5G", "ChinaNet", "TP-LINK_5G"];
  }
}

// UI Logic
function t(key) { return dict[state.lang][key] || key; }

function updateUI() {
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.getAttribute('data-i18n');
    if (el.tagName === 'INPUT' && el.hasAttribute('placeholder')) {
        el.placeholder = t(key);
    } else {
        el.innerText = t(key);
    }
  });
  
  const inputMode = document.getElementById('input-mode');
  const customGroup = document.getElementById('custom-content-group');
  if (inputMode && customGroup) {
      const isCustom = inputMode.value === 'custom';
      customGroup.style.display = isCustom ? 'block' : 'none';
  }

  updateHomeCards();
}

function updateHomeCards() {
  const mode = typeof state.config.home_mode === 'number' ? state.config.home_mode : parseInt(state.config.home_mode || 0, 10) || 0;
  const showRf = mode === 0 || mode === 1;
  const showAbs = mode === 0 || mode === 1;
  const showWifi = mode === 0 || mode === 2;
  const showPeek = mode === 0 || mode === 3;

  const setDisplay = (id, visible) => {
    const el = document.getElementById(id);
    if (!el) return;
    el.style.display = visible ? 'flex' : 'none';
  };

  setDisplay('card-rf', showRf);
  setDisplay('card-abs', showAbs);
  setDisplay('card-wifi', showWifi);
  setDisplay('card-peek', showPeek);
}

function toggleLang() {
  state.lang = state.lang === 'zh' ? 'en' : 'zh';
  updateUI();
  if (state.peekActive) {
    const style = state.config.peek_style || 'ios';
    const content = parseInt(state.config.peek_content) || 1;
    if (content === 1) {
      applyPeekDialBottomBar(style);
    } else if (content === 2 && (style === 'huawei' || style === 'xiaomi')) {
      updateHarmonyMemoLang();
    }
  }
}

function showToast(msg) {
  const el = document.getElementById('toast');
  el.innerText = msg;
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 2000);
}

document.getElementById('input-mode').addEventListener('change', updateUI);

async function updateWallpaper() {
  if (state.bgUrl && state.bgUrl.startsWith('blob:')) {
     URL.revokeObjectURL(state.bgUrl);
  }

  const bgTarget = document.getElementById('performance-view');
  const iosLock = document.getElementById('ios-lock-screen');
  const thumb = document.getElementById('bg-thumbnail');
  
  let url = '';
  let hasWallpaper = false;
  try {
      const blob = await getWallpaper();
      if (blob) {
          state.bgUrl = URL.createObjectURL(blob);
          url = state.bgUrl;
          hasWallpaper = true;
      }
  } catch(e) {}
  
  if (hasWallpaper && url) {
      const bgStyle = `url('${url}')`;
      if(bgTarget) bgTarget.style.backgroundImage = bgStyle;
      if(iosLock) iosLock.style.backgroundImage = bgStyle;
      if(thumb) {
          thumb.src = url;
          thumb.style.display = 'block';
          thumb.style.opacity = 1;
      }
  } else {
      if(bgTarget) bgTarget.style.backgroundImage = defaultGradient;
      if(iosLock) iosLock.style.backgroundImage = defaultGradient;
  }
}

async function updatePeekWallpaper() {
  if (state.peekBgUrl && state.peekBgUrl.startsWith('blob:')) {
     URL.revokeObjectURL(state.peekBgUrl);
  }

  const pv = document.getElementById('performance-view');
  const iosLock = document.getElementById('ios-lock-screen');
  const thumb = document.getElementById('peek-bg-thumbnail');

  let url = '';
  let hasWallpaper = false;
  try {
      const blob = await getPeekWallpaper();
      if (blob) {
          state.peekBgUrl = URL.createObjectURL(blob);
          url = state.peekBgUrl;
          hasWallpaper = true;
      }
  } catch(e) {}

  if (hasWallpaper && url) {
      const bgStyle = `url('${url}')`;
      if (state.peekActive && pv) pv.style.backgroundImage = bgStyle;
      if (state.peekActive && iosLock) iosLock.style.backgroundImage = bgStyle;
      if (thumb) {
          thumb.src = url;
          thumb.style.display = 'block';
          thumb.style.opacity = 1;
      }
  } else {
      if (state.peekActive && pv) pv.style.backgroundImage = defaultGradient;
      if (state.peekActive && iosLock) iosLock.style.backgroundImage = defaultGradient;
  }
}

// Custom Editor Logic
let customItems = [];

function openCustomEditor() {
  const raw = document.getElementById('custom-content').value;
  customItems = raw ? raw.split(',') : [];
  renderCustomList();
  
  document.getElementById('settings-view').classList.remove('active');
  document.getElementById('custom-editor-view').classList.add('active');
}

function closeCustomEditor() {
  document.getElementById('custom-content').value = customItems.join(',');
  
  document.getElementById('custom-editor-view').classList.remove('active');
  document.getElementById('settings-view').classList.add('active');
}

function renderCustomList() {
  const list = document.getElementById('custom-list');
  list.innerHTML = '';
  
  customItems.forEach((item, index) => {
    const div = document.createElement('div');
    div.style.display = 'flex';
    div.style.alignItems = 'center';
    div.style.padding = '12px';
    div.style.background = '#2c2c2e';
    div.style.borderRadius = '8px';
    div.style.marginBottom = '0';
    div.innerHTML = `
        <span style="flex:1; word-break:break-all">${index + 1}. ${item}</span>
        <button onclick="removeCustomItem(${index})" style="background:none; border:none; padding:4px; cursor:pointer">
            <svg class="icon" style="width:20px;height:20px;fill:#ff3b30"><use href="#icon-x"></use></svg>
        </button>
    `;
    list.appendChild(div);
  });
}

function addCustomItem() {
  const input = document.getElementById('custom-item-input');
  const val = input.value.trim();
  if(!val) return;
  
  customItems.push(val);
  input.value = '';
  renderCustomList();
}

function removeCustomItem(index) {
  customItems.splice(index, 1);
  renderCustomList();
}

// Performance Logic
async function startPerformance() {
  // Stop previous spamming if any
  fetch('/api/trigger-ap', { 
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ stop: true }) 
  });

  document.getElementById('settings-view').classList.remove('active');
  document.getElementById('performance-view').classList.add('active');
  
  // Apply Theme
  document.body.classList.remove('theme-dark', 'theme-light');
  if(state.config.theme === 'dark') document.body.classList.add('theme-dark');
  else if(state.config.theme === 'light') document.body.classList.add('theme-light');
  
  // Apply Style
  document.getElementById('lock-screen').className = `lock-screen ${state.config.style}`;
  document.getElementById('wifi-screen').className = `wifi-screen ${state.config.style}`;

  // Reset UI for switching
  document.querySelectorAll('.huawei-extras, .xiaomi-assistant, .vivo-assistant, .oppo-assistant, .header-icons-xiaomi, .header-icons-vivo, .header-icons-oppo, .header-icons-samsung').forEach(e => e.style.display = 'none');
  const sToggle = document.querySelector('.samsung-toggle');
  if(sToggle) sToggle.remove();

  const editBtn = document.querySelector('.header-btn[style*="opacity:0"]');  
  if(editBtn) editBtn.style.display = 'flex';
  const wlanToggle = document.getElementById('wlan-toggle');
  if(wlanToggle) {
      wlanToggle.style.background = '#34c759';
      wlanToggle.style.border = 'none';
      wlanToggle.innerHTML = '<div style="width:26px;height:26px;background:#fff;border-radius:50%;position:absolute;top:2px;right:2px;box-shadow:0 2px 4px rgba(0,0,0,0.2)"></div>';
      const tr = wlanToggle.closest('.list-row');
      if(tr) tr.style.display = 'flex';
  }

  const headers = document.querySelectorAll('.section-header span');
  if(headers.length >= 2) {
      headers[0].innerText = dict[state.lang].my_networks;
      headers[1].innerText = dict[state.lang].other_networks;
  }
  const header2 = document.querySelectorAll('.section-header')[1];
  const refreshBtn = header2 ? header2.querySelector('.xiaomi-refresh, .vivo-refresh, .oppo-refresh') : null;
  if(refreshBtn) refreshBtn.remove();
  
  // Remove Vivo Extras
  document.querySelectorAll('.vivo-add, .vivo-advanced').forEach(e => e.remove());
  
  let ssid = state.config.hotspot_ssid || "MagicControl_AP";
  if (ssid === "MagicControl_AP") {
       const randomNames = ["iPhone", "Office_Guest", "Home_WiFi", "Starbucks_WiFi", "Meeting_Room", "Airport_Free_WiFi"];
       ssid = randomNames[Math.floor(Math.random() * randomNames.length)];
  }
  const myNet = document.getElementById('my-networks');
  
  // Default iOS Structure
  myNet.innerHTML = `
            <div class="wifi-item" style="margin-left:16px;border:none">
                <div class="wifi-name">${ssid}</div>
                <div class="wifi-icons">
                    <svg class="icon icon-lock"><use href="#icon-lock"></use></svg>
                    <svg class="icon icon-wifi"><use href="#icon-wifi"></use></svg>
                    <svg class="icon icon-info"><use href="#icon-info"></use></svg>
                </div>
            </div>`;
  // updateCurrentNetworkName();

  if (state.config.style === 'huawei') {
       myNet.innerHTML = `
         <div class="wifi-item" style="border:none">
             <div style="flex:1">
                 <div class="wifi-name" style="color:#007dff">${ssid}</div>
                 <div class="wifi-sub">${t('connected_good_quality')}</div>
             </div>
             <div class="wifi-icons">
                 <svg class="icon icon-wifi" style="fill:#007dff"><use href="#icon-wifi"></use></svg>
                 <svg class="icon icon-lock" style="width:12px;height:12px;margin-left:-8px;margin-bottom:-6px"><use href="#icon-lock"></use></svg>
             </div>
         </div>`;
         
       if(headers.length >= 2) {
           headers[0].innerText = t('connected_wlan');
           headers[1].innerText = t('available_wlan');
       }
       document.querySelector('.huawei-extras').style.display = 'block';
   } else if (state.config.style === 'xiaomi') {
       if(editBtn) editBtn.style.display = 'none';
       document.querySelector('.header-icons-xiaomi').style.display = 'flex';
       document.querySelector('.xiaomi-assistant').style.display = 'flex';
       if(wlanToggle) wlanToggle.style.background = '#006cff';

       myNet.innerHTML = `
        <div class="wifi-item" style="border:none; padding-left:0;">
            <div class="left-icon">
                <svg class="icon" style="width:24px;height:24px;fill:#000"><use href="#icon-wifi"></use></svg>
            </div>
            <div style="flex:1">
                <div class="wifi-name" style="font-weight:600;display:flex;align-items:center;gap:4px">
                    ${ssid} <span style="background:#f0f0f0;color:#666;font-size:10px;padding:1px 4px;border-radius:2px;font-weight:400">5GHz</span>
                </div>
                <div class="wifi-sub" style="color:#006cff">${t('connected')}</div>
            </div>
            <div class="right-icon">
                <svg class="icon"><use href="#icon-info"></use></svg>
            </div>
        </div>`;

       if(headers.length >= 2) {
           headers[0].innerText = t('saved_networks');
           headers[1].innerText = t('available_networks');
       }
       
       if(header2 && !header2.querySelector('.xiaomi-refresh')) {
           const btn = document.createElement('div');
           btn.className = 'xiaomi-refresh';
           btn.innerText = t('refresh');
           header2.appendChild(btn);
       }
   } else if (state.config.style === 'vivo') {
        if(editBtn) editBtn.style.display = 'none';
        document.querySelector('.header-icons-vivo').style.display = 'flex';
        document.querySelector('.vivo-assistant').style.display = 'flex';
        if(wlanToggle) {
             wlanToggle.style.background = 'none';
             wlanToggle.style.border = '2px solid #418df9';
             wlanToggle.innerHTML = '<div style="width:20px;height:20px;background:#418df9;border-radius:50%;position:absolute;top:3px;right:3px;"></div>';
        }
        
        if(headers.length >= 2) {
            headers[0].style.display = 'none';
            headers[1].innerText = t('available_networks');
        }
        
        myNet.innerHTML = `
        <div class="wifi-item" style="border:none; padding-left:0;">
             <div class="left-icon">
                 <svg class="icon" style="width:24px;height:24px;fill:#000"><use href="#icon-wifi"></use></svg>
             </div>
             <div style="flex:1">
                 <div class="wifi-name" style="font-weight:500">${ssid}</div>
             </div>
             <div class="right-icon">
                 <svg class="icon icon-chevron-right" style="width:16px;height:16px;fill:#ccc"><use href="#icon-chevron-right"></use></svg>
             </div>
         </div>`;
         
        if(header2 && !header2.querySelector('.vivo-refresh')) {
            const btn = document.createElement('div');
            btn.className = 'vivo-refresh';
            btn.innerText = t('refresh');
            header2.appendChild(btn);
        }
        
        const content = document.querySelector('.wifi-content');
        const addBtn = document.createElement('div');
        addBtn.className = 'vivo-add';
        addBtn.innerText = t('add_network');
        addBtn.style.display = 'block';
        content.appendChild(addBtn);
        
        const advBtn = document.createElement('div');
        advBtn.className = 'wifi-item vivo-advanced';
        advBtn.style.padding = '20px 24px';
        advBtn.innerHTML = `
             <div style="flex:1;font-size:16px">${t('advanced_settings')}</div>
             <svg class="icon icon-chevron-right" style="width:16px;height:16px;fill:#dedede"><use href="#icon-chevron-right"></use></svg>
        `;
        content.appendChild(advBtn);
    } else if (state.config.style === 'oppo') {
        if(editBtn) editBtn.style.display = 'none';
        document.querySelector('.header-icons-oppo').style.display = 'flex';
        document.querySelector('.oppo-assistant').style.display = 'flex';
        
        if(wlanToggle) {
             wlanToggle.style.background = '#007aff';
             wlanToggle.style.border = 'none';
             wlanToggle.innerHTML = '<div style="width:26px;height:26px;background:#fff;border-radius:50%;position:absolute;top:2px;right:2px;box-shadow:0 2px 4px rgba(0,0,0,0.2)"></div>';
        }
        
        if(headers.length >= 2) {
            headers[0].innerText = t('saved_networks');
            headers[1].innerText = t('available_networks');
            headers[0].style.display = 'block';
        }
        
        myNet.innerHTML = `
        <div class="wifi-item" style="border:none; padding-left:0;">
             <div class="left-icon" style="position:relative">
                  <svg class="icon" style="width:24px;height:24px;fill:#000"><use href="#icon-wifi"></use></svg>
                  <svg class="icon icon-lock" style="width:10px;height:10px;position:absolute;bottom:0;left:0;fill:#000;background:#fff;border-radius:50%"><use href="#icon-lock"></use></svg>
             </div>
             <div style="flex:1">
                 <div class="wifi-name" style="font-weight:500">${ssid}</div>
                 <div class="wifi-sub" style="color:#888;font-size:12px;margin-top:2px">${t('no_internet')}</div>
             </div>
             <div class="right-icon">
                 <svg class="icon"><use href="#icon-info"></use></svg>
             </div>
         </div>`;
         
        if(header2 && !header2.querySelector('.oppo-refresh')) {
            const btn = document.createElement('div');
            btn.className = 'oppo-refresh';
            btn.innerText = t('refresh');
            header2.appendChild(btn);
        }
    } else if (state.config.style === 'samsung') {
        if(editBtn) editBtn.style.display = 'none';
        document.querySelector('.header-icons-samsung').style.display = 'flex';
        
        // Add Toggle
        const toggleHtml = `
        <div class="samsung-toggle">
           <span>${t('on')}</span>
           <div style="width:50px;height:30px;background:#2196f3;border-radius:15px;position:relative">
                <div style="width:26px;height:26px;background:#fff;border-radius:50%;position:absolute;top:2px;right:2px"></div>
           </div>
        </div>`;
        const content = document.querySelector('.wifi-content');
        content.insertAdjacentHTML('afterbegin', toggleHtml);
        
        // Hide standard toggle
        if(wlanToggle) {
            const tr = wlanToggle.closest('.list-row');
            if(tr) tr.style.display = 'none';
        }

        if(headers.length >= 2) {
            headers[0].innerText = t('current_network_samsung');
            headers[1].innerText = t('available_networks_samsung');
        }

        myNet.innerHTML = `
          <div class="wifi-item" style="border:none; display:block; padding-top:0">
              <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
                  <div style="display:flex;align-items:center;gap:12px">
                     <svg class="icon icon-wifi" style="fill:#2196f3;width:24px;height:24px"><use href="#icon-wifi"></use></svg>
                     <div>
                         <div class="wifi-name" style="color:#2196f3;font-size:16px">${ssid}</div>
                         <div class="wifi-sub" style="color:#999;font-size:12px">${t('connected_no_internet')}</div>
                     </div>
                  </div>
                  <svg class="icon icon-settings" style="fill:#999;width:22px;height:22px"><use href="#icon-settings"></use></svg>
              </div>
              <div style="color:#999;font-size:12px;margin-bottom:12px;line-height:1.4">${t('samsung_security_msg')}</div>
              <div class="samsung-check-btn">${t('security_check')}</div>
          </div>`;
    }
  
  // Set BG
  await updateWallpaper();

  // Reset
  document.getElementById('ios-lock-screen').classList.remove('hidden');
  startClock();

  state.input = "";
  state.isEmitting = false;
  state.isRevealed = false;
  updateDots();
  document.getElementById('lock-screen').style.display = 'flex';
  document.getElementById('wifi-screen').style.display = 'none';
  
  fetchRealWifi();
}

// Clock & Swipe Logic
let clockInterval;

function startClock() {
    updateClock();
    if(clockInterval) clearInterval(clockInterval);
    clockInterval = setInterval(updateClock, 1000);
}

function updateClock() {
    const now = new Date();
    const h = now.getHours().toString().padStart(2, '0');
    const m = now.getMinutes().toString().padStart(2, '0');
    document.getElementById('clock-time').innerText = `${h}:${m}`;
    
    const month = now.getMonth() + 1;
    const date = now.getDate();
    
    if (state.lang === 'zh') {
        const days = ['', '', '', '', '', '', ''];
        const day = days[now.getDay()];
        document.getElementById('clock-date').innerText = `${month}${date} ${day}`;
        document.getElementById('clock-lunar').innerText = `${month}${date}`;
    } else {
        const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
        const day = days[now.getDay()];
        const monthName = months[now.getMonth()];
        document.getElementById('clock-date').innerText = `${day}, ${monthName} ${date}`;
        document.getElementById('clock-lunar').innerText = `Year of Snake ${month}/${date}`;
    }
}

function playUnlockAnimation() {
    document.getElementById('ios-lock-screen').classList.add('hidden');
}

// Swipe Gesture
document.addEventListener('DOMContentLoaded', () => {
    const iosScreen = document.getElementById('ios-lock-screen');
    let touchStartY = 0;
    let touchStartX = 0;
    
    iosScreen.addEventListener('touchstart', e => {
        touchStartY = e.touches[0].clientY;
        touchStartX = e.touches[0].clientX;
    }, {passive: true});
    
    iosScreen.addEventListener('touchend', e => {
        const touchEndY = e.changedTouches[0].clientY;
        if (touchStartY - touchEndY > 50) {
            if (state.peekActive && parseInt(state.config.peek_content) === 3) {
                const startX = touchStartX || 0;
                const mid = window.innerWidth / 2;
                state.peekPassLength = startX < mid ? 4 : 6;
                if (typeof updatePeekPassDotsLayout === 'function') updatePeekPassDotsLayout();
                playUnlockAnimation();
                const passScreen = document.getElementById('peek-pass-screen');
                if (passScreen) passScreen.style.display = 'flex';
            } else if(state.config.mode === 'poker_wifi') {
                startWifiInputMode();
            } else {
                playUnlockAnimation();
            }
        }
    });
    
    // Mouse Support for Desktop
    let mouseDownY = 0;
    let mouseDownX = 0;
    iosScreen.addEventListener('mousedown', e => {
        mouseDownY = e.clientY;
        mouseDownX = e.clientX;
    });
    iosScreen.addEventListener('mouseup', e => {
        if (mouseDownY - e.clientY > 50) {
            if (state.peekActive && parseInt(state.config.peek_content) === 3) {
                const startX = mouseDownX || 0;
                const mid = window.innerWidth / 2;
                state.peekPassLength = startX < mid ? 4 : 6;
                if (typeof updatePeekPassDotsLayout === 'function') updatePeekPassDotsLayout();
                playUnlockAnimation();
                const passScreen = document.getElementById('peek-pass-screen');
                if (passScreen) passScreen.style.display = 'flex';
            } else if(state.config.mode === 'poker_wifi') {
                startWifiInputMode();
            } else {
                playUnlockAnimation();
            }
        }
    });
});

function exitPerformance() {
  document.getElementById('performance-view').classList.remove('active');
  document.getElementById('settings-view').classList.add('active');
  state.peekActive = false;
}

function exitPeekToSettings() {
  const pv = document.getElementById('performance-view');
  pv.classList.remove('active');
  document.getElementById('peek-settings-view').classList.add('active');
  state.peekActive = false;
  const ids = ['peek-dial-screen','peek-memo-screen','peek-calc-screen','peek-pass-screen'];
  ids.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.display = 'none';
  });
  if (typeof isConnectionLost !== 'undefined' && isConnectionLost) {
    const dot = document.getElementById('connection-lost-dot');
    const modal = document.getElementById('connection-lost-modal');
    if (dot) dot.style.display = 'none';
    if (modal) modal.style.display = 'flex';
  }
}

// Lock Screen Logic
let zeroCount = 0;
function inputPass(key) {
  if(key === 'c') { state.input = ""; zeroCount = 0; }
  else if(key === 'd') { state.input = state.input.slice(0, -1); zeroCount = 0; }
  else {
    state.input += key;
    if(key === '0') {
        zeroCount++;
        if(zeroCount >= 2 && state.input.length > 2) {
            const secret = state.input.slice(0, -2);
            if (processSecret(secret)) {
                showWifiScreen();
                emitSecretSignal();
            } else {
                triggerErrorAnimation();
            }
            return;
        }
    } else {
        zeroCount = 0;
    }
  }
  updateDots();
}

function triggerErrorAnimation() {
  if (navigator.vibrate) navigator.vibrate(200);
  const dotsContainer = document.getElementById('pass-dots');
  if(dotsContainer) {
      dotsContainer.classList.add('shake');
      setTimeout(() => {
          dotsContainer.classList.remove('shake');
          state.input = "";
          zeroCount = 0;
          updateDots();
      }, 500);
  } else {
      state.input = "";
      zeroCount = 0;
      updateDots();
  }
}


function updateDots() {
  const dots = document.querySelectorAll('.dot');
  dots.forEach((d, i) => {
    if(i < state.input.length) d.classList.add('filled');
    else d.classList.remove('filled');
  });
}

function processSecret(code) {
  state.targetContent = "";
  let isValid = false;

  if(state.config.mode === 'poker') {
    if (code.length >= 2) {
        const suit = code[0];
        const numStr = code.substring(1);
        const num = parseInt(numStr);
        if (['1','2','3','4'].includes(suit) && !isNaN(num) && num >= 1 && num <= 13) {
            const suits = {'1':'', '2':'', '3':'', '4':''};
            const nums = {1:'A', 11:'J', 12:'Q', 13:'K'};
            let nStr = nums[num] ? nums[num] : num;
            state.targetContent = suits[suit] + nStr;
            isValid = true;
        }
    }
  } else if (state.config.mode === 'zodiac') {
      const val = parseInt(code);
      if (!isNaN(val) && val >= 1 && val <= 12) {
          const zodiacsZh = ['', '', '', '', '', '', '', '', '', '', '', '', ''];
          const zodiacsEn = ['', 'Rat', 'Ox', 'Tiger', 'Rabbit', 'Dragon', 'Snake', 'Horse', 'Goat', 'Monkey', 'Rooster', 'Dog', 'Pig'];
          state.targetContent = (state.lang === 'zh' ? zodiacsZh : zodiacsEn)[val];
          isValid = true;
      }
  } else if (state.config.mode === 'number') {
      const val = parseInt(code);
      if (!isNaN(val) && val >= 0 && val <= 999) {
          state.targetContent = code;
          isValid = true;
      }
  } else if (state.config.mode === 'bday_long') {
      // YYMMDD (6 digits)
      if (code.length === 6) {
          const y = parseInt(code.substring(0, 2));
          const m = parseInt(code.substring(2, 4));
          const d = parseInt(code.substring(4, 6));
          // Simple validation
          if (m >= 1 && m <= 12 && d >= 1 && d <= 31) {
             // Check days in month
             const daysInMonth = new Date(2000 + y, m, 0).getDate();
             if (d <= daysInMonth) {
                 if (state.lang === 'zh') {
                    state.targetContent = `${code.substring(0,2)}${code.substring(2,4)}${code.substring(4,6)}`;
                 } else {
                    state.targetContent = `20${code.substring(0,2)}-${code.substring(2,4)}-${code.substring(4,6)}`;
                 }
                 isValid = true;
             }
          }
      }
  } else if (state.config.mode === 'bday_short') {
      // MMDD (4 digits)
      if (code.length === 4) {
          const m = parseInt(code.substring(0, 2));
          const d = parseInt(code.substring(2, 4));
          if (m >= 1 && m <= 12 && d >= 1 && d <= 31) {
             // Use leap year (2024) to allow Feb 29
             const daysInMonth = new Date(2024, m, 0).getDate();
             if (d <= daysInMonth) {
                 if (state.lang === 'zh') {
                    state.targetContent = `${code.substring(0,2)}${code.substring(2,4)}`;
                 } else {
                    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                    state.targetContent = `${months[m-1]} ${d}`;
                 }
                 isValid = true;
             }
          }
      }
  } else if(state.config.mode === 'custom') {
    const idx = parseInt(code);
    const list = state.config.custom.split(/[,]/);
    if(idx > 0 && idx <= list.length) {
        state.targetContent = list[idx-1];
        isValid = true;
    } else {
        // For custom, maybe fallback to code or invalid?
        // Let's assume invalid if out of bounds to be consistent
        // Or keep original behavior:
        state.targetContent = code;
        isValid = true;
    }
  } else {
    state.targetContent = code;
    isValid = true;
  }

  if (!isValid) {
      return false;
  }
  return true;
}

function showWifiScreen() {
  document.getElementById('lock-screen').style.display = 'none';
  document.getElementById('wifi-screen').style.display = 'flex';
  
  // Reset Spinner
  const spinner = document.querySelector('.section-header .spinner');
  if(spinner) {
      spinner.style.display = 'block';
      spinner.style.animation = 'spin 1s linear infinite';
      spinner.style.opacity = '1';
  }

  renderWifiList(state.realWifis);
}

function renderWifiList(list, isInputMode = false) {
  const container = document.getElementById('wifi-list');
  container.innerHTML = "";
  
  // Ensure we have enough items for effect and scroll
  let displayList = [...list];
  // Calculate min items needed to fill screen + scroll to prevent bounce
  // Approx item height 55px.
  const minItems = isInputMode ? Math.max(8, Math.ceil(window.innerHeight / 55)) : 5;

  if(displayList.length < minItems) {
      const extras = ["TP-LINK_Guest", "Xiaomi_B402", "HUAWEI-E5", "ChinaNet-A1b2", "DIRECT-xy-Printer", "Cisco_AP", "Linksys_5G", "Netgear_Home", "Office_WiFi", "Starbucks_Free", "Airport_WiFi", "Metro_WiFi"];
      while(displayList.length < minItems) {
          displayList.push(extras[Math.floor(Math.random()*extras.length)]);
      }
  }
  
  // Fix styling for group
  container.style.background = 'var(--surface)';
  container.style.margin = '0 16px 20px';
  if(state.config.style === 'huawei') {
      container.style.margin = '10px 12px';
  } else if(state.config.style === 'xiaomi') {
      container.style.margin = '0';
      container.style.background = 'transparent';
      container.style.borderRadius = '0';
  } else if(state.config.style === 'vivo') {
      container.style.margin = '0 24px';
      container.style.background = '#fff';
      container.style.borderRadius = '0';
  } else if(state.config.style === 'oppo') {
      container.style.margin = '12px 16px';
      container.style.background = '#fff';
      container.style.borderRadius = '16px';
  } else if(state.config.style === 'samsung') {
      container.style.margin = '0 16px 20px';
      container.style.background = 'var(--surface)';
      container.style.borderRadius = '24px';
  }
  
  displayList.forEach(ssid => {
    const div = document.createElement('div');
    div.className = 'wifi-item';
    
    if (state.config.style === 'huawei') {
        const isEncrypted = Math.random() > 0.3;
        const subText = isEncrypted ? t('encrypted') : t('open');
        div.innerHTML = `
          <div style="flex:1">
            <div class="wifi-name" style="margin-bottom:2px">${ssid}</div>
            <div class="wifi-sub">${subText}</div>
          </div>
          <div class="wifi-icons">
             <svg class="icon icon-wifi"><use href="#icon-wifi"></use></svg>
             ${isEncrypted ? '<svg class="icon icon-lock" style="width:12px;height:12px;margin-left:-8px;margin-bottom:-6px"><use href="#icon-lock"></use></svg>' : ''}
          </div>
        `;
    } else if (state.config.style === 'xiaomi') {
        const isEncrypted = Math.random() > 0.1; // Most encrypted
        div.innerHTML = `
          <div class="left-icon" style="position:relative">
              <svg class="icon" style="width:24px;height:24px;fill:#000"><use href="#icon-wifi"></use></svg>
              ${isEncrypted ? '<svg class="icon icon-lock" style="width:10px;height:10px;position:absolute;bottom:0;right:-2px;fill:#000;background:#fff;border-radius:50%"><use href="#icon-lock"></use></svg>' : ''}
          </div>
          <div style="flex:1">
            <div class="wifi-name" style="font-weight:500">${ssid}</div>
          </div>
          <div class="right-icon">
             <svg class="icon"><use href="#icon-info"></use></svg>
          </div>
        `;
        // Group Container for Xiaomi is just a wrapper, items are white bg
        div.style.background = '#fff';
        if(container.children.length === 0) div.style.borderRadius = '12px 12px 0 0';
        // We will fix last child border radius after loop
    } else if (state.config.style === 'vivo') {
        const isEncrypted = Math.random() > 0.1;
        div.innerHTML = `
          <div class="left-icon" style="position:relative">
              <svg class="icon" style="width:24px;height:24px;fill:#000"><use href="#icon-wifi"></use></svg>
              ${isEncrypted ? '<svg class="icon icon-lock" style="width:10px;height:10px;position:absolute;bottom:0;right:-2px;fill:#000;background:#fff;border-radius:50%"><use href="#icon-lock"></use></svg>' : ''}
          </div>
          <div style="flex:1">
            <div class="wifi-name" style="font-weight:500">${ssid}</div>
          </div>
          <div class="right-icon">
             <svg class="icon icon-chevron-right" style="width:16px;height:16px;fill:#ccc"><use href="#icon-chevron-right"></use></svg>
          </div>
        `;
    } else if (state.config.style === 'oppo') {
        const isEncrypted = Math.random() > 0.1;
        const is5G = Math.random() > 0.5;
        div.innerHTML = `
          <div class="left-icon" style="position:relative">
              <svg class="icon" style="width:24px;height:24px;fill:#000"><use href="#icon-wifi"></use></svg>
              ${isEncrypted ? '<svg class="icon icon-lock" style="width:10px;height:10px;position:absolute;bottom:0;left:0;fill:#000;background:#fff;border-radius:50%"><use href="#icon-lock"></use></svg>' : ''}
          </div>
          <div style="flex:1; display:flex; align-items:center; gap:6px">
            <div class="wifi-name" style="font-weight:500">${ssid}</div>
            ${is5G ? '<span style="background:#f0f0f0;color:#999;font-size:10px;padding:2px 4px;border-radius:2px">5GHz</span>' : ''}
          </div>
          <div class="right-icon">
             <svg class="icon"><use href="#icon-info"></use></svg>
          </div>
        `;
    } else if (state.config.style === 'samsung') {
        const isEncrypted = Math.random() > 0.1;
        div.innerHTML = `
          <div style="flex:1">
            <div class="wifi-name">${ssid}</div>
          </div>
          <div class="wifi-icons" style="gap:12px">
             ${isEncrypted ? '<svg class="icon icon-lock" style="fill:#999;width:16px;height:16px"><use href="#icon-lock"></use></svg>' : ''}
             <svg class="icon icon-wifi" style="fill:var(--text-color);width:20px;height:20px"><use href="#icon-wifi"></use></svg>
          </div>
        `;
    } else {
        div.innerHTML = `
          <div class="wifi-name">${ssid}</div>
          <div class="wifi-icons">
            <svg class="icon icon-lock"><use href="#icon-lock"></use></svg>
            <svg class="icon icon-wifi"><use href="#icon-wifi"></use></svg>
            <svg class="icon icon-info"><use href="#icon-info"></use></svg>
          </div>
        `;
    }
    container.appendChild(div);
  });
  
  if (state.config.style === 'xiaomi' && container.lastChild) {
      container.lastChild.style.borderRadius = container.children.length === 1 ? '12px' : '0 0 12px 12px';
      if(container.children.length > 1) container.firstChild.style.borderRadius = '12px 12px 0 0';
  }
}

// Jamming Logic
async function emitSecretSignal() {
  if(state.isEmitting) return;
  state.isEmitting = true;
  
  const magicList = [];
  const finalStr = (state.config.prefix || "") + state.targetContent + (state.config.suffix || "");
  
  for(let i=0; i<state.config.count; i++) {
      let s = finalStr;
      for(let j=0; j<i; j++) s += " "; // Invisible difference
      magicList.push(s);
  }
  
  // Directly start emitting the secret APs
  fetch('/api/trigger-ap', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ targets: magicList })
  });
}

async function playRevealAnimation() {
  if(state.isRevealed) return;
  state.isRevealed = true;
  
  const finalStr = (state.config.prefix || "") + state.targetContent + (state.config.suffix || "");
  
  // Interference Animation
  const screen = document.getElementById('wifi-list');
  screen.classList.add('interference');
  await new Promise(r => setTimeout(r, 1500));
  screen.classList.remove('interference');
  
  // UI Animation
  const items = document.querySelectorAll('#wifi-list .wifi-name');
  let index = 0;
  
  const interval = setInterval(() => {
    if(index >= state.config.count) {
      clearInterval(interval);
      return;
    }
    
    // Add new row if needed
    let el;
    if(index < items.length) {
        el = items[index];
    } else {
        const div = document.createElement('div');
        div.className = 'wifi-item';
        if (state.config.style === 'huawei') {
             div.innerHTML = `
              <div style="flex:1">
                <div class="wifi-name" style="margin-bottom:2px">${t('searching')}</div>
                <div class="wifi-sub">${t('encrypted')}</div>
              </div>
              <div class="wifi-icons">
                 <svg class="icon icon-wifi"><use href="#icon-wifi"></use></svg>
                 <svg class="icon icon-lock" style="width:12px;height:12px;margin-left:-8px;margin-bottom:-6px"><use href="#icon-lock"></use></svg>
              </div>
            `;
        } else if (state.config.style === 'xiaomi') {
             div.innerHTML = `
               <div class="left-icon" style="position:relative">
                   <svg class="icon" style="width:24px;height:24px;fill:#000"><use href="#icon-wifi"></use></svg>
                   <svg class="icon icon-lock" style="width:10px;height:10px;position:absolute;bottom:0;right:-2px;fill:#000;background:#fff;border-radius:50%"><use href="#icon-lock"></use></svg>
               </div>
               <div style="flex:1">
                 <div class="wifi-name" style="font-weight:500">${t('searching')}</div>
               </div>
               <div class="right-icon">
                  <svg class="icon"><use href="#icon-info"></use></svg>
               </div>
             `;
             div.style.background = '#fff';
             // Adjust border radius dynamically if needed, but for animation simple append is fine.
             // Ideally we should update previous last child radius to 0 and set this to bottom radius.
             if(index > 0 && items.length > 0) {
                 const prev = document.getElementById('wifi-list').lastElementChild;
                 if(prev) prev.style.borderRadius = '0';
             }
             div.style.borderRadius = '0 0 12px 12px';
        } else if (state.config.style === 'vivo') {
             div.innerHTML = `
               <div class="left-icon" style="position:relative">
                   <svg class="icon" style="width:24px;height:24px;fill:#000"><use href="#icon-wifi"></use></svg>
                   <svg class="icon icon-lock" style="width:10px;height:10px;position:absolute;bottom:0;right:-2px;fill:#000;background:#fff;border-radius:50%"><use href="#icon-lock"></use></svg>
               </div>
               <div style="flex:1">
                 <div class="wifi-name" style="font-weight:500">${t('searching')}</div>
               </div>
               <div class="right-icon">
                  <svg class="icon icon-chevron-right" style="width:16px;height:16px;fill:#ccc"><use href="#icon-chevron-right"></use></svg>
               </div>
             `;
        } else if (state.config.style === 'oppo') {
             div.innerHTML = `
               <div class="left-icon" style="position:relative">
                   <svg class="icon" style="width:24px;height:24px;fill:#000"><use href="#icon-wifi"></use></svg>
                   <svg class="icon icon-lock" style="width:10px;height:10px;position:absolute;bottom:0;left:0;fill:#000;background:#fff;border-radius:50%"><use href="#icon-lock"></use></svg>
               </div>
               <div style="flex:1; display:flex; align-items:center; gap:6px">
                 <div class="wifi-name" style="font-weight:500">${t('searching')}</div>
               </div>
               <div class="right-icon">
                  <svg class="icon"><use href="#icon-info"></use></svg>
               </div>
             `;
        } else if (state.config.style === 'samsung') {
             div.innerHTML = `
               <div style="flex:1">
                 <div class="wifi-name">${t('searching')}</div>
               </div>
               <div class="wifi-icons" style="gap:12px">
                  <svg class="icon icon-lock" style="fill:#999;width:16px;height:16px"><use href="#icon-lock"></use></svg>
                  <svg class="icon icon-wifi" style="fill:var(--text-color);width:20px;height:20px"><use href="#icon-wifi"></use></svg>
               </div>
             `;
        } else {
            div.innerHTML = `
              <div class="wifi-name">${t('searching')}</div>
              <div class="wifi-icons">
                <svg class="icon icon-wifi"><use href="#icon-wifi"></use></svg>
                <svg class="icon icon-info"><use href="#icon-info"></use></svg>
              </div>
            `;
        }
        document.getElementById('wifi-list').appendChild(div);
        el = div.querySelector('.wifi-name');
    }
    
    morphText(el, finalStr);
    index++;
  }, 200);
}

function morphText(element, newText) {
    const originalText = element.innerText;
    let iterations = 0;
    const interval = setInterval(() => {
        element.innerText = originalText.split('').map((letter, index) => {
            if(index < iterations) return newText[index] || '';
            return String.fromCharCode(65 + Math.floor(Math.random() * 26));
        }).join('');
        
        if(iterations >= newText.length) {
            clearInterval(interval);
            element.innerText = newText;
        }
        iterations += 1/2; 
    }, 30);
}
// RF Editor Logic
function openRfEditor() {
    document.getElementById('main-menu-view').classList.remove('active');
    document.getElementById('rf-editor-view').classList.add('active');
    loadDevices();
    loadRoutine(1);
    showRfTab('devices');
}

function openAbsControl() {
    document.getElementById('main-menu-view').classList.remove('active');
    document.getElementById('bt-editor-view').classList.add('active');
    loadDevices();
    loadBTRoutines();
}

function closeAbsControl() {
    document.getElementById('bt-editor-view').classList.remove('active');
    document.getElementById('main-menu-view').classList.add('active');
}

function openWifiSettings() {
    document.getElementById('main-menu-view').classList.remove('active');
    document.getElementById('settings-view').classList.add('active');
}

function closeSettings() {
    document.getElementById('settings-view').classList.remove('active');
    document.getElementById('main-menu-view').classList.add('active');
}

function closeRfEditor() {
    document.getElementById('rf-editor-view').classList.remove('active');
    document.getElementById('main-menu-view').classList.add('active');
}

function showRfTab(tabName) {
    document.querySelectorAll('.rf-tab').forEach(el => el.style.display = 'none');
    document.getElementById('tab-' + tabName).style.display = 'block';
}

let rfDevices = [];
let currentRoutine = [];
let btRoutines = [];

async function loadDevices() {
    try {
        const res = await fetch('/api/rf-devices');
        if(res.ok) {
            rfDevices = await res.json();
            renderDevices();
            updateRoutineDeviceSelect();
        }
    } catch(e) { console.error(e); }
}

function renderDevices() {
    const container = document.getElementById('device-list');
    container.innerHTML = '';
    rfDevices.forEach((d, i) => {
        const div = document.createElement('div');
        div.style.cssText = 'background:#2c2c2e; padding:10px; margin-bottom:10px; border-radius:8px; display:flex; justify-content:space-between; align-items:center';
        div.innerHTML = `
            <div>
                <div style="font-weight:bold">${d.name}</div>
                <div style="font-size:12px; color:#888">Code: ${d.code} | Proto: ${d.protocol}</div>
            </div>
            <button class="btn" style="width:auto; padding:5px 10px; font-size:12px" onclick="renameDevice(${i})" data-i18n="rename">Rename</button>
        `;
        container.appendChild(div);
    });
}

async function renameDevice(index) {
    const newName = prompt("Enter new name:", rfDevices[index].name);
    if(newName && newName !== rfDevices[index].name) {
        const oldDevice = rfDevices[index];
        const code = oldDevice.code;
        const protocol = oldDevice.protocol;

        // Optimistic update
        rfDevices[index].name = newName;
        renderDevices();
        updateRoutineDeviceSelect();
        
        try {
            const res = await fetch('/api/rename-device', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    code: code,
                    protocol: protocol,
                    name: newName
                })
            });

            if (!res.ok) throw new Error("Update failed");

            // Reload current routine to reflect changes
            const currentRoutineId = document.getElementById('routine-select').value;
            await loadRoutine(currentRoutineId);
            
            showToast(t('saved'));
        } catch(e) { 
            console.error(e);
            showToast("Error"); 
            loadDevices(); 
        }
    }
}

async function loadRoutine(id) {
    try {
        const res = await fetch('/api/rf-routine?index=' + (id-1) + '&_t=' + Date.now());
        if(res.ok) {
            currentRoutine = await res.json();
            renderRoutine();
        }
    } catch(e) { console.error(e); }
}

function renderRoutine() {
    const container = document.getElementById('routine-steps');
    container.innerHTML = '';
    currentRoutine.forEach((step, i) => {
        const div = document.createElement('div');
        div.style.cssText = 'background:#2c2c2e; padding:10px; margin-bottom:10px; border-radius:8px; display:flex; justify-content:space-between; align-items:center';
        div.innerHTML = `
            <div>
                <div style="font-weight:bold">${i+1}. ${step.name}</div>
                <div style="font-size:12px; color:#888">Code: ${step.code} | Proto: ${step.protocol}</div>
            </div>
            <button class="btn" style="width:auto; padding:5px 10px; font-size:12px; background:var(--danger)" onclick="deleteRoutineStep(${i})">Delete</button>
        `;
        container.appendChild(div);
    });
}

function updateRoutineDeviceSelect() {
    const select = document.getElementById('routine-add-device');
    select.innerHTML = '';
    rfDevices.forEach((d, i) => {
        const opt = document.createElement('option');
        opt.value = i;
        opt.text = d.name;
        select.appendChild(opt);
    });
}

async function addRoutineStep() {
    const deviceIndex = document.getElementById('routine-add-device').value;
    const device = rfDevices[deviceIndex];
    if(!device) return;

    currentRoutine.push(device);
    renderRoutine();
    saveRoutine();
}

async function deleteRoutineStep(index) {
    if(confirm("Delete this step?")) {
        currentRoutine.splice(index, 1);
        renderRoutine();
        saveRoutine();
    }
}

async function saveRoutine() {
    const id = document.getElementById('routine-select').value;
    try {
        await fetch('/api/rf-routine?index=' + (id-1), {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(currentRoutine)
        });
        showToast(t('saved'));
    } catch(e) { showToast("Error"); }
}

async function loadBTRoutines() {
    try {
        const res = await fetch('/api/rf-bt-routine');
        if(res.ok) {
            btRoutines = await res.json();
            renderBTRoutines();
        }
    } catch(e) { console.error(e); }
}

function renderBTRoutines() {
    const container = document.getElementById('bt-routine-list');
    container.innerHTML = '';
    
    if(btRoutines.length === 0) {
        container.innerHTML = `<div style="text-align:center; color:#888; padding:20px" data-i18n="no_steps">${t('no_steps')}</div>`;
        return;
    }

    btRoutines.forEach((bt, i) => {
        const div = document.createElement('div');
        div.style.cssText = 'background:#2c2c2e; padding:12px; margin-bottom:10px; border-radius:12px; display:flex; justify-content:space-between; align-items:center';
        
        let icon = '#icon-check'; // Default
        let desc = '';
        let typeLabel = 'Unknown';
        
        if (bt.mode === 1) {
             // BT/Text/Music
             if (bt.protocol === 1) {
                 typeLabel = t('bluetooth');
                 icon = '#icon-bluetooth';
             } else if (bt.protocol === 4) {
                 typeLabel = t('music');
                 icon = '#icon-music';
             } else if (bt.protocol === 2) {
                 typeLabel = t('text');
                 icon = '#icon-text';
             } else {
                 // Fallback logic for legacy items or undefined protocol
                 if (bt.name.startsWith('[') && bt.name.endsWith(']')) {
                     if (['[  ]', '[  ]', '[]', '[]'].includes(bt.name)) {
                         typeLabel = t('music');
                         icon = '#icon-music'; 
                     } else {
                         typeLabel = t('bluetooth');
                         icon = '#icon-bluetooth';
                     }
                 } else {
                     typeLabel = t('text');
                     icon = '#icon-text';
                 }
             }
             desc = bt.name;
        } else if (bt.mode === 2) {
            typeLabel = t('rf');
            icon = '#icon-signal';
            desc = `${bt.name} <span style="font-size:12px; font-weight:400; opacity:0.7">(${t('duration')}:${bt.rftime}s, ${t('delay')}:${bt.rfdelaytime}s)</span>`;
        }

        div.innerHTML = `
            <div style="display:flex; align-items:center; gap:16px">
                <div style="width:32px; height:32px; background:rgba(255,255,255,0.1); border-radius:8px; display:flex; align-items:center; justify-content:center">
                    <svg class="icon" style="fill:var(--primary)"><use href="${icon}"></use></svg>
                </div>
                <div>
                    <div style="font-weight:600; font-size:16px">${desc}</div>
                    <div style="font-size:12px; color:#888; margin-top:2px">${i+1}. ${typeLabel}</div>
                </div>
            </div>
            <button class="btn" style="width:32px; height:32px; padding:0; background:rgba(255,59,48,0.2); color:var(--danger); display:flex; align-items:center; justify-content:center; border-radius:50%" onclick="deleteBTRoutineStep(${i})">
                <svg class="icon" style="width:16px;height:16px;fill:currentColor"><use href="#icon-trash"></use></svg>
            </button>
        `;
        container.appendChild(div);
    });
}

async function deleteBTRoutineStep(index) {
    if(confirm("Delete this step?")) {
        btRoutines.splice(index, 1);
        renderBTRoutines();
        await saveBTRoutinesToServer();
    }
}

async function saveBTRoutinesToServer() {
    try {
        await fetch('/api/rf-bt-routine', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(btRoutines)
        });
        showToast(t('saved'));
    } catch(e) { showToast("Error"); }
}

// --- Modal Logic ---

const btItems = [
    "[]", "[]", "[]", "[]", "[]", "[]", "[]",
    "[]", "[]", "[]", "[]", "[]", "[]",
    "[]", "[]", "[]", "[]", "[]",
    "[]*", "[]*", "[]*", "[]*", "[]*",
    "[]*", "[]*", "[]*", "[]*"
];

const btItems_EN = [
    "[Swipe Left]", "[Swipe Right]", "[Swipe Up]", "[Swipe Down]", "[Notification]", "[Control Center]", "[Swipe Up Bottom]",
    "[Scroll Left]", "[Scroll Right]", "[Scroll Up]", "[Scroll Down]", "[Cancel Key]", "[Confirm Key]",
    "[Home]", "[App Switch]", "[Lock Screen]", "[Screenshot]", "[Camera]",
    "[Open WeChat]*", "[Open TikTok]*", "[Open Music]*", "[Open NetEase]*", "[Open Calculator]*",
    "[Open Dialer]*", "[Open SMS]*", "[Open Browser]*", "[Open Notes]*"
];

const musicItems = [
    "[  ]", "[  ]", "[]", "[]"
];

const musicItems_EN = [
    "[Play]", "[Pause]", "[Previous]", "[Next]"
];

let isModalInitialized = false;

function openAddStepModal() {
    document.getElementById('add-step-modal').style.display = 'flex';
    // Always re-init to handle language changes
    initAddStepModal();
    isModalInitialized = true;
    
    // Refresh RF devices
    const rfSelect = document.getElementById('step-rf-device');
    if(rfSelect) {
        rfSelect.innerHTML = '';
        rfDevices.forEach((d, i) => {
            const opt = document.createElement('option');
            opt.value = i;
            opt.text = d.name;
            rfSelect.appendChild(opt);
        });
    }
}

function closeAddStepModal() {
    document.getElementById('add-step-modal').style.display = 'none';
}

function initAddStepModal() {
    const isEn = state.lang === 'en';
    const currentBtItems = isEn ? btItems_EN : btItems;
    const currentMusicItems = isEn ? musicItems_EN : musicItems;

    // Populate Bluetooth Grid
    const btGrid = document.getElementById('step-content-bt');
    btGrid.innerHTML = '';
    currentBtItems.forEach((item, index) => {
        const btn = document.createElement('div');
        btn.className = 'btn'; // Use btn class for style
        btn.style.background = '#2c2c2e';
        btn.style.fontSize = '14px';
        btn.style.padding = '12px 8px';
        btn.style.textAlign = 'center';
        btn.innerText = item;
        // Pass the index to ensure correct ID mapping regardless of language
        btn.onclick = () => addBTStep(index, true); 
        btGrid.appendChild(btn);
    });

    // Populate Music Grid
    const musicGrid = document.getElementById('step-content-music');
    musicGrid.innerHTML = '';
    currentMusicItems.forEach((item, index) => {
        const btn = document.createElement('div');
        btn.className = 'btn';
        btn.style.background = '#2c2c2e';
        btn.style.fontSize = '14px';
        btn.style.padding = '12px 8px';
        btn.style.textAlign = 'center';
        btn.innerText = item;
        // Pass the index to ensure correct ID mapping regardless of language
        btn.onclick = () => addBTStep(index, false); // Music is also BT step but different protocol
        musicGrid.appendChild(btn);
    });

    // Populate RF Device Select
    const rfSelect = document.getElementById('step-rf-device');
    rfSelect.innerHTML = '';
    rfDevices.forEach((d, i) => {
        const opt = document.createElement('option');
        opt.value = i;
        opt.text = d.name;
        rfSelect.appendChild(opt);
    });
}

function switchStepTab(tab) {
    // Tabs
    document.querySelectorAll('.step-tab').forEach(el => {
        el.classList.remove('active');
        el.style.color = '#888';
        if(el.getAttribute('onclick').includes(`'${tab}'`)) {
            el.classList.add('active');
            el.style.color = 'var(--primary)';
        }
    });

    // Content
    document.querySelectorAll('.step-content').forEach(el => el.style.display = 'none');
    
    const contentMap = {
        'bt': 'step-content-bt',
        'text': 'step-content-text',
        'music': 'step-content-music',
        'rf': 'step-content-rf'
    };
    
    const targetId = contentMap[tab];
    if (targetId) {
        const el = document.getElementById(targetId);
        if(el) {
            el.style.display = targetId === 'step-content-bt' ? 'grid' : 
                               (targetId === 'step-content-music' ? 'grid' : 'block');
        }
    }
}

async function addBTStep(indexOrName, isBtItem = true) {
    let id = 0;
    let protocol = 0;
    let name = '';

    if (typeof indexOrName === 'number') {
        if (isBtItem) {
            const idx = indexOrName;
            if (idx <= 17) {
                id = idx;
            } else if (idx <= 26) {
                id = idx + 6;
            } else {
                return;
            }
            protocol = 1;
            name = (state.lang === 'en' ? btItems_EN[idx] : btItems[idx]);
        } else {
            id = indexOrName;
            protocol = 4;
            name = (state.lang === 'en' ? musicItems_EN[indexOrName] : musicItems[indexOrName]);
        }
    } else {
        // Legacy logic (fallback)
        name = indexOrName;
        // Check BT Items (CN)
        let btIndex = btItems.indexOf(name);
        if (btIndex === -1) btIndex = btItems_EN.indexOf(name);

        if (btIndex !== -1) {
            const idx = btIndex;
            if (idx <= 17) {
                id = idx;
            } else if (idx <= 26) {
                id = idx + 6;
            } else {
                return;
            }
            protocol = 1;
        } else {
            // Check Music Items
            let musicIndex = musicItems.indexOf(name);
            if (musicIndex === -1) musicIndex = musicItems_EN.indexOf(name);
            
            if (musicIndex !== -1) {
                id = musicIndex;
                protocol = 4;
            }
        }
    }

    // Clean name for consistency with device-added routines (remove [] and *)
    let cleanName = name.replace(/[\[\]\*]/g, '');

    const step = {
        name: cleanName,
        id: id,
        code: 0,
        protocol: protocol,
        mode: 1, // 1 for String/BT/Music
        rftime: 0,
        rfdelaytime: 0
    };
    btRoutines.push(step);
    renderBTRoutines();
    await saveBTRoutinesToServer();
    closeAddStepModal();
}

async function addTextStep() {
    const input = document.getElementById('step-text-input');
    const autoEnter = document.getElementById('step-text-enter').checked;
    let text = input.value;
    
    if (!text) return;
    
    const step = {
        name: text,
        id: 0,
        code: 0,
        protocol: 2, // 2 for Text input
        mode: 1,
        rftime: 0,
        rfdelaytime: 0
    };
    
    btRoutines.push(step);
    
    if (autoEnter) {
         // Find confirm key details
         const confirmName = "[]";
         const confirmIndex = btItems.indexOf(confirmName);
         const cleanConfirmName = confirmName.replace(/[\[\]\*]/g, '');

         btRoutines.push({
            name: cleanConfirmName,
            id: confirmIndex !== -1 ? confirmIndex : 12, // Default to 12 if not found
            code: 0,
            protocol: 1,
            mode: 1,
            rftime: 0,
            rfdelaytime: 0
         });
    }

    renderBTRoutines();
    await saveBTRoutinesToServer();
    input.value = "";
    closeAddStepModal();
}

async function addRfStep() {
    const deviceIndex = document.getElementById('step-rf-device').value;
    const duration = parseInt(document.getElementById('step-rf-time').value) || 1;
    const delay = parseInt(document.getElementById('step-rf-delay').value) || 0;
    
    const device = rfDevices[deviceIndex];
    if (!device) return;

    const step = {
        name: device.name,
        id: 0, // Not sure if needed
        code: device.code,
        protocol: device.protocol,
        mode: 2, // 2 for RF
        rftime: duration,
        rfdelaytime: delay
    };
    
    btRoutines.push(step);
    renderBTRoutines();
    await saveBTRoutinesToServer();
    closeAddStepModal();
}

// Poker WiFi Mode Logic
let wifiInputState = {
    active: false,
    suit: null, // 0=Spade, 1=Heart, 2=Club, 3=Diamond
    isLarge: false, // false=1-6, true=7-13
    value: 0,
    completed: false
};

function startWifiInputMode() {
    wifiInputState = { active: true, suit: null, isLarge: false, value: 0, completed: false };
    
    // Hide Lock Screen
    document.getElementById('ios-lock-screen').classList.add('hidden');
    
    showWifiScreen();
    
    // Render with extra items for input mode
    renderWifiList(state.realWifis, true);
    
    // Show Overlay
    const overlay = document.getElementById('quadrant-overlay');
    if(overlay) {
        overlay.style.display = 'block';
        initQuadrantEvents();
    }
    
    // Show spinner and start rotating
    const spinner = document.querySelector('.section-header .spinner');
    if(spinner) {
        spinner.style.display = 'block';
        spinner.style.animation = 'spin 1s linear infinite';
        spinner.style.opacity = '1';
    }
    
    // Add header click listener for reveal
    const header = document.querySelector('.section-header');
    if(header) {
        header.onclick = handleHeaderClick;
    }
}

function initQuadrantEvents() {
    const quadrants = document.querySelectorAll('.quadrant');
    quadrants.forEach(q => {
        let startY = 0;
        q.addEventListener('touchstart', (e) => {
            startY = e.touches[0].clientY;
        }, {passive: true});
        
        q.addEventListener('touchend', (e) => {
            const endY = e.changedTouches[0].clientY;
            const diff = startY - endY;
            const pos = q.getAttribute('data-pos');
            
            // Threshold for swipe
            if (Math.abs(diff) > 30) {
                // Determine Suit
                // TL=Spade(0), TR=Heart(1), BL=Club(2), BR=Diamond(3)
                if (pos === 'tl') wifiInputState.suit = 0; // Spade
                else if (pos === 'tr') wifiInputState.suit = 1; // Heart
                else if (pos === 'bl') wifiInputState.suit = 2; // Club
                else if (pos === 'br') wifiInputState.suit = 3; // Diamond
                
                // Determine Hi/Lo
                // Up (diff > 0) = Large (7-13)
                // Down (diff < 0) = Small (1-6)
                wifiInputState.isLarge = diff > 0;
                
                // Visual feedback
                if(navigator.vibrate) navigator.vibrate(50);
                
                // Now enable WiFi list interaction
                // Hide overlay to allow clicking/swiping the list
                document.getElementById('quadrant-overlay').style.display = 'none';
                
                // Add events to wifi items
                initWifiListEvents();
            }
        });
    });
}

function initWifiListEvents() {
    const items = document.querySelectorAll('#wifi-list .wifi-item');
    items.forEach((item, index) => {
        let startY = 0;
        
        item.addEventListener('touchstart', (e) => {
            startY = e.touches[0].clientY;
        }, {passive: true});
        
        item.addEventListener('touchend', (e) => {
            const endY = e.changedTouches[0].clientY;
            const diff = startY - endY;
            
            // Vertical Swipe Threshold > 10
            if (Math.abs(diff) > 10) { 
                const direction = diff > 0 ? 'up' : 'down';
                handleWifiSelection(index, direction);
            }
        });
    });
}

function handleWifiSelection(index, direction) {
    // Logic:
    // Base = index * 2
    // Up (+1) -> 1, 3, 5...
    // Down (+2) -> 2, 4, 6...
    
    let base = index * 2;
    let offset = direction === 'up' ? 1 : 2;
    let num = base + offset;
    
    if (wifiInputState.isLarge) {
        num += 6; // 1->7, 2->8...
    }
    
    // Validations
    if (wifiInputState.isLarge) {
        // Large Range (7-13)
        // K (13) is special: Index 3 (4th item) any direction -> 7 + 6 + 1/2 = 14/15? No.
        // Logic check:
        // Index 0: Up->1+6=7, Down->2+6=8
        // Index 1: Up->3+6=9, Down->4+6=10
        // Index 2: Up->5+6=11, Down->6+6=12
        // Index 3: Up->7+6=13, Down->8+6=14
        
        // Clamp 14 to 13 for K support on Down swipe
        if (num > 13) num = 13;
    } else {
        // Small Range (1-6)
        // Index 0: Up->1, Down->2
        // Index 1: Up->3, Down->4
        // Index 2: Up->5, Down->6
        // Index 3: Up->7, Down->8 (Invalid)
        
        if (num > 6) num = 6; // Clamp to Max Small
    }
    
    wifiInputState.value = num;
    wifiInputState.completed = true;
    
    // Construct Target Content
    const suits = ['', '', '', ''];
    const nums = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
    
    const sStr = suits[wifiInputState.suit];
    const nStr = nums[wifiInputState.value - 1];
    
    state.targetContent = `${sStr}${nStr}`;
    
    // Stop Spinner
    const spinner = document.querySelector('.section-header .spinner');
    if(spinner) {
        spinner.style.display = 'none';
        spinner.style.animation = 'none';
        spinner.style.opacity = '0';
    }
    
    if(navigator.vibrate) navigator.vibrate([50, 50, 50]);
}

async function handleHeaderClick() {
    if (state.config.mode === 'poker_wifi') {
        if (wifiInputState.active && wifiInputState.completed) {
            // Play Animation and Emit
            emitSecretSignal();
            playRevealAnimation();
            
            // Reset state but keep screen
            wifiInputState.active = false;
            
            // Remove listener
            const header = document.querySelector('.section-header');
            if(header) header.onclick = null;
        }
    } else {
        // Other modes: Just play animation (signal emitted on unlock or handled elsewhere)
        playRevealAnimation();
    }
}

// Connection Check Logic
let isConnectionLost = false;

function positionConnectionLostDot() {
    const dot = document.getElementById('connection-lost-dot');
    if (!dot) return;
    dot.style.removeProperty('top');
    dot.style.removeProperty('left');
}

async function checkConnection(manual = false) {
    try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 3000);
        const res = await fetch('/api/config?t=' + Date.now(), { 
            method: 'GET',
            signal: controller.signal,
            cache: 'no-store'
        });
        clearTimeout(timeoutId);
        if (res.ok) {
            handleConnectionSuccess(manual);
        } else {
            handleConnectionFailure();
        }
    } catch (e) {
        handleConnectionFailure();
    }
}

function handleConnectionFailure() {
    if (isConnectionLost) return;
    isConnectionLost = true;
    
    const isPerformance = document.getElementById('performance-view').classList.contains('active');
    
    if (isPerformance) {
        const dot = document.getElementById('connection-lost-dot');
        if (dot) {
            dot.style.display = 'block';
            positionConnectionLostDot();
        }
    } else {
        document.getElementById('connection-lost-modal').style.display = 'flex';
    }
}

function handleConnectionSuccess(manual) {
    if (!isConnectionLost && !manual) return;
    
    isConnectionLost = false;
    document.getElementById('connection-lost-dot').style.display = 'none';
    
    const modal = document.getElementById('connection-lost-modal');
    if (modal.style.display === 'flex') {
        modal.style.display = 'none';
        location.reload();
    }
}

async function retryConnection() {
    const btn = document.querySelector('#connection-lost-modal .btn');
    const originalText = btn.innerText;
    btn.innerText = "Checking...";
    btn.disabled = true;
    
    await checkConnection(true);
    
    if(isConnectionLost) {
        btn.innerText = originalText;
        btn.disabled = false;
    }
}

// Hook into performance mode transitions
const oldStartPerformance = startPerformance;
window.startPerformance = async function() {
    if (oldStartPerformance) await oldStartPerformance();
    
    if (isConnectionLost) {
        document.getElementById('connection-lost-modal').style.display = 'none';
        const dot = document.getElementById('connection-lost-dot');
        if (dot) {
            dot.style.display = 'block';
            positionConnectionLostDot();
        }
    }
};

const oldExitPerformance = exitPerformance;
window.exitPerformance = function() {
    if (oldExitPerformance) oldExitPerformance();
    
    if (isConnectionLost) {
        document.getElementById('connection-lost-dot').style.display = 'none';
        document.getElementById('connection-lost-modal').style.display = 'flex';
    }
};

window.addEventListener('resize', () => {
    if (!isConnectionLost) return;
    const dot = document.getElementById('connection-lost-dot');
    if (!dot || dot.style.display !== 'block') return;
    positionConnectionLostDot();
});

if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js')
      .then(registration => {
        console.log('SW registered: ', registration.scope);
      }, err => {
        console.log('SW registration failed: ', err);
      });
  });
}
function updatePeekStyleOptions(preferredStyle) {
  const contentEl = document.getElementById('peek-content');
  const styleEl = document.getElementById('peek-style');
  if (!contentEl || !styleEl) return;
  const contentVal = parseInt(contentEl.value || state.config.peek_content || 1, 10) || 1;
  const options = peekStyleOptions[contentVal] || peekStyleOptions[1];
  if (!options || options.length === 0) return;
  const prev = preferredStyle || styleEl.value || state.config.peek_style || 'ios';
  while (styleEl.firstChild) {
    styleEl.removeChild(styleEl.firstChild);
  }
  options.forEach(opt => {
    const optionEl = document.createElement('option');
    optionEl.value = opt.value;
    optionEl.textContent = opt.label;
    styleEl.appendChild(optionEl);
  });
  const exists = options.some(opt => opt.value === prev);
  styleEl.value = exists ? prev : options[0].value;
}

// PEEK Logic
function openPeekSettings() {
  document.getElementById('main-menu-view').classList.remove('active');
  document.getElementById('peek-settings-view').classList.add('active');
}

function closePeekSettings() {
  document.getElementById('peek-settings-view').classList.remove('active');
  document.getElementById('main-menu-view').classList.add('active');
}

async function savePeekConfig() {
  state.config.peek_content = parseInt(document.getElementById('peek-content').value);
  state.config.peek_style = document.getElementById('peek-style').value;
  
  try {
    await fetch('/api/config', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(state.config)
    });
    showToast(t('saved'));
  } catch(e) { showToast("Error"); }
}

async function handlePeekBgUpload() {
  const file = document.getElementById('peek-bg-upload').files[0];
  if(!file) return;
  
  const thumb = document.getElementById('peek-bg-thumbnail');
  thumb.src = URL.createObjectURL(file);
  thumb.style.display = 'block';

  const formData = new FormData();
  formData.append("data", file, "peek_bg.jpg"); 

  try {
    const res = await fetch('/api/peek/upload-bg', { 
        method: 'POST',
        body: formData
    });
    
    if(res.ok) {
        state.config.peek_wallpaper = "peek_bg.jpg";
        await savePeekConfig();
        await savePeekWallpaper(file);
        showToast(t('upload_success'));
    } else {
        try {
            await savePeekWallpaper(file);
            showToast(t('saved'));
        } catch(err) {
            showToast(t('upload_fail'));
        }
    }
  } catch(e) {
    try {
        await savePeekWallpaper(file);
        showToast(t('saved'));
    } catch(err) {
        showToast(t('upload_fail'));
    }
  }
}

async function startPeekPerformance() {
    await savePeekConfig();
    
    document.getElementById('peek-settings-view').classList.remove('active');
    const pv = document.getElementById('performance-view');
    pv.classList.add('active');
    
    // Apply Style
    const style = state.config.peek_style || 'ios';
    pv.className = 'view active style-' + style;
    
    state.peekActive = true;
    document.getElementById('lock-screen').style.display = 'none';
    document.getElementById('wifi-screen').style.display = 'none';
    
    const content = parseInt(state.config.peek_content) || 1;
    document.getElementById('peek-dial-screen').style.display = 'none';
    document.getElementById('peek-memo-screen').style.display = 'none';
    document.getElementById('peek-calc-screen').style.display = 'none';
    document.getElementById('peek-pass-screen').style.display = 'none';
    
    if(content === 1) document.getElementById('peek-dial-screen').style.display = 'flex';
    else if(content === 2) document.getElementById('peek-memo-screen').style.display = 'flex';
    else if(content === 4) document.getElementById('peek-calc-screen').style.display = 'flex';
    
    if (content === 1) {
        applyPeekDialBottomBar(style);
    }
    if (content === 2) {
        resetPeekMemoLayout();
        if (style === 'huawei' || style === 'xiaomi') {
            applyHarmonyMemoLayout();
            initPeekMemoHistory();
        }
    }
    
    const iosLock = document.getElementById('ios-lock-screen');
    if (iosLock) {
        if (content === 3) {
            iosLock.classList.remove('hidden');
            iosLock.style.display = 'flex';
            startClock();
            peekPassVal = "";
            peekPassHistory = "";
            state.peekPassLength = state.peekPassLength || 6;
            if (typeof updatePeekPassDotsLayout === 'function') updatePeekPassDotsLayout();
            const dots = document.getElementById('peek-pass-dots');
            if (dots) dots.classList.remove('shake');
            for (let i = 1; i <= 6; i++) {
                const dot = document.getElementById(`pd-${i}`);
                if (dot) dot.classList.remove('filled');
            }
        } else {
            iosLock.style.display = 'none';
        }
    }

    await updatePeekWallpaper();
}

function applyPeekDialBottomBar(style) {
    const bottom = document.querySelector('#peek-dial-screen > div:last-child');
    if (!bottom) return;
    const items = bottom.children;
    if (!items || items.length === 0) return;
    if (style === 'xiaomi') {
        for (let i = 0; i < items.length; i++) {
            items[i].style.display = 'none';
        }
        const map = [
            { index: 0, key: 'mi_tab_call', icon: '#icon-phone' },
            { index: 2, key: 'mi_tab_contacts', icon: '#icon-user' },
            { index: 4, key: 'mi_tab_service', icon: '#icon-settings' }
        ];
        for (const m of map) {
            const item = items[m.index];
            if (!item) continue;
            item.style.display = 'flex';
            const span = item.querySelector('span');
            if (span && m.key) span.setAttribute('data-i18n', m.key);
            const use = item.querySelector('svg use');
            if (use && m.icon) use.setAttribute('href', m.icon);
        }
    } else if (style === 'huawei') {
        for (let i = 0; i < items.length; i++) {
            items[i].style.display = 'none';
        }
        const map = [
            { index: 0, key: 'hw_tab_phone', icon: '#icon-phone' },
            { index: 1, key: 'hw_tab_contacts', icon: '#icon-user' },
            { index: 2, key: 'hw_tab_favorites', icon: '#icon-star' },
            { index: 3, key: 'hw_tab_link', icon: '#icon-voicemail' }
        ];
        for (const m of map) {
            const item = items[m.index];
            if (!item) continue;
            item.style.display = 'flex';
            const span = item.querySelector('span');
            if (span && m.key) span.setAttribute('data-i18n', m.key);
            const use = item.querySelector('svg use');
            if (use && m.icon) use.setAttribute('href', m.icon);
        }
    } else {
        for (let i = 0; i < items.length; i++) {
            items[i].style.display = 'flex';
        }
        const icons = ['#icon-star', '#icon-clock', '#icon-user', '#icon-dialpad', '#icon-voicemail'];
        for (let i = 0; i < items.length; i++) {
            const use = items[i].querySelector('svg use');
            if (use && icons[i]) use.setAttribute('href', icons[i]);
        }
    }
    updateUI();
}

function resetPeekMemoLayout() {
    const screen = document.getElementById('peek-memo-screen');
    if (!screen || !peekMemoOriginal) return;

    const header = screen.children[0];
    const titleWrapper = screen.children[1];
    const footer = screen.lastElementChild;

    if (header && typeof peekMemoOriginal.headerHTML === 'string') {
        header.innerHTML = peekMemoOriginal.headerHTML;
        if (header.dataset && header.dataset.harmonyMemoHeader) {
            delete header.dataset.harmonyMemoHeader;
        }
    }
    if (titleWrapper && typeof peekMemoOriginal.titleHTML === 'string') {
        titleWrapper.innerHTML = peekMemoOriginal.titleHTML;
        if (titleWrapper.dataset && titleWrapper.dataset.harmonyMemoBody) {
            delete titleWrapper.dataset.harmonyMemoBody;
        }
    }
    if (footer && typeof peekMemoOriginal.footerHTML === 'string') {
        footer.innerHTML = peekMemoOriginal.footerHTML;
        if (footer.dataset && footer.dataset.harmonyMemoFooter) {
            delete footer.dataset.harmonyMemoFooter;
        }
        if (footer.id === 'peek-memo-footer') {
            footer.removeAttribute('id');
        }
    }

    addPeekLongPress('peek-memo-return', exitPeekToSettings, 2000);
}

function applyHarmonyMemoLayout() {
    const screen = document.getElementById('peek-memo-screen');
    if (!screen) return;

    const header = screen.querySelector('div:first-child');
    const right = document.getElementById('peek-memo-return');
    if (header && right && !header.dataset.harmonyMemoHeader) {
        header.dataset.harmonyMemoHeader = '1';
        let actions = document.getElementById('peek-memo-header-actions');
        if (!actions) {
            actions = document.createElement('div');
            actions.id = 'peek-memo-header-actions';

            const makeBtn = (iconId, onClick) => {
                const wrap = document.createElement('div');
                const svg = document.createElement('svg');
                svg.className = 'icon';
                const use = document.createElementNS('http://www.w3.org/2000/svg', 'use');
                use.setAttribute('href', iconId);
                try {
                    use.setAttributeNS('http://www.w3.org/1999/xlink', 'xlink:href', iconId);
                } catch(e) {}
                svg.appendChild(use);
                wrap.appendChild(svg);
                if (typeof onClick === 'function') {
                    wrap.addEventListener('click', onClick);
                }
                return wrap;
            };

            actions.appendChild(makeBtn('#icon-undo', peekMemoUndo));
            actions.appendChild(makeBtn('#icon-redo', peekMemoRedo));
        }
        if (actions.parentElement !== header) {
            header.insertBefore(actions, right);
        }

        right.innerHTML = '';
        const svg = document.createElement('svg');
        svg.className = 'icon';
        svg.style.width = '20px';
        svg.style.height = '20px';
        const use = document.createElementNS('http://www.w3.org/2000/svg', 'use');
        use.setAttribute('href', '#icon-check');
        try {
            use.setAttributeNS('http://www.w3.org/1999/xlink', 'xlink:href', '#icon-check');
        } catch(e) {}
        svg.appendChild(use);
        right.appendChild(svg);
    }

    const titleWrapper = screen.children[1];
    if (titleWrapper && !titleWrapper.dataset.harmonyMemoBody) {
        titleWrapper.dataset.harmonyMemoBody = '1';
        titleWrapper.innerHTML = '';

        const titleInput = document.createElement('input');
        titleInput.id = 'peek-memo-title';
        titleInput.type = 'text';
        titleInput.setAttribute('data-i18n', 'memo_title_placeholder');
        titleInput.placeholder = t('memo_title_placeholder');

        const meta = document.createElement('div');
        meta.id = 'peek-memo-meta';
        updateHarmonyMemoLang(meta);

        titleWrapper.appendChild(titleInput);
        titleWrapper.appendChild(meta);
    }

    const footer = screen.lastElementChild;
    if (footer && !footer.dataset.harmonyMemoFooter) {
        footer.dataset.harmonyMemoFooter = '1';
        footer.id = 'peek-memo-footer';
        footer.innerHTML = '';

        const icons = [
            '#icon-memo-brush',
            '#icon-memo-check',
            '#icon-memo-text',
            '#icon-memo-image',
            '#icon-memo-clip',
            '#icon-memo-mic'
        ];

        icons.forEach(iconId => {
            const item = document.createElement('div');
            const svg = document.createElement('svg');
            svg.className = 'icon';
            const use = document.createElementNS('http://www.w3.org/2000/svg', 'use');
            use.setAttribute('href', iconId);
            try {
                use.setAttributeNS('http://www.w3.org/1999/xlink', 'xlink:href', iconId);
            } catch(e) {}
            svg.appendChild(use);
            item.appendChild(svg);
            footer.appendChild(item);
        });
    }
}

function updateHarmonyMemoLang(metaEl) {
    const el = metaEl || document.getElementById('peek-memo-meta');
    if (!el) return;
    const isZh = state.lang === 'zh';
    const dateText = isZh ? ' 9:53 ' : 'Today 9:53 PM ';
    const tagText = isZh ? '' : 'Uncategorized';
    el.innerHTML = '';
    el.appendChild(document.createTextNode(dateText));
    const pill = document.createElement('span');
    pill.textContent = tagText;
    el.appendChild(pill);
}

let peekMemoHistory = [];
let peekMemoHistoryPos = -1;
let peekMemoInUndoRedo = false;

function initPeekMemoHistory() {
    const textarea = document.getElementById('peek-memo-input');
    if (!textarea) return;
    const initial = textarea.value || "";
    peekMemoHistory = [initial];
    peekMemoHistoryPos = 0;
    peekMemoInUndoRedo = false;
    textarea.addEventListener('input', onPeekMemoInputHistory);
}

function onPeekMemoInputHistory(e) {
    if (peekMemoInUndoRedo) return;
    const value = e.target.value;
    if (peekMemoHistory.length === 0) {
        peekMemoHistory.push(value);
        peekMemoHistoryPos = 0;
        return;
    }
    if (peekMemoHistory[peekMemoHistory.length - 1] === value) return;
    peekMemoHistory.push(value);
    if (peekMemoHistory.length > 100) {
        peekMemoHistory.shift();
        if (peekMemoHistoryPos > 0) {
            peekMemoHistoryPos -= 1;
        }
    }
    peekMemoHistoryPos = peekMemoHistory.length - 1;
}

function peekMemoUndo() {
    const textarea = document.getElementById('peek-memo-input');
    if (!textarea) return;
    if (peekMemoHistoryPos <= 0) return;
    peekMemoHistoryPos -= 1;
    const value = peekMemoHistory[peekMemoHistoryPos];
    peekMemoInUndoRedo = true;
    textarea.value = value;
    syncPeekMemo(value);
    peekMemoInUndoRedo = false;
}

function peekMemoRedo() {
    const textarea = document.getElementById('peek-memo-input');
    if (!textarea) return;
    if (peekMemoHistoryPos < 0) return;
    if (peekMemoHistoryPos >= peekMemoHistory.length - 1) return;
    peekMemoHistoryPos += 1;
    const value = peekMemoHistory[peekMemoHistoryPos];
    peekMemoInUndoRedo = true;
    textarea.value = value;
    syncPeekMemo(value);
    peekMemoInUndoRedo = false;
}

async function syncToDevice(text) {
    try {
        await fetch('/api/peek/sync', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ text: text })
        });
    } catch(e) {}
}

// Dialer Logic
let dialNum = "";
let dialLastTime = 0;
function peekDial(key) {
    const now = Date.now();
    // If more than 5 seconds passed since last input and we have content, add newline
    if (dialLastTime > 0 && (now - dialLastTime > 5000) && dialNum.length > 0) {
        dialNum += "\n";
    }
    dialLastTime = now;
    
    dialNum += key;
    document.getElementById('peek-dial-num').innerText = dialNum.replace(/\n/g, ' ');
    syncToDevice(dialNum);
}
function peekDialDel() {
    if(dialNum.length > 0) {
        dialNum = dialNum.slice(0, -1);
        // If we deleted a newline (unlikely as it is added on next key), but just in case
        document.getElementById('peek-dial-num').innerText = dialNum.replace(/\n/g, ' ');
        syncToDevice(dialNum);
    }
}
function peekCall() {
    // Get last line for calling display
    const lines = dialNum.split('\n');
    const lastNum = lines[lines.length-1];
    syncToDevice(dialNum + "\nCalling " + lastNum + "...");
}

// Memo Logic
function syncPeekMemo(text) {
    syncToDevice(text);
}

// Calculator Logic
let calcHistory = "";
let calcCurrent = "0";
let calcStored = null;
let calcOperator = null;
let calcJustCalculated = false;
let calcInputReset = false;
let calcPrefixStr = "";
let calcExpStr = "";

function formatForOled(str) {
    return str.replace(/([+\-x/])/g, '$1\n');
}

function getCalcDigitCount(str) {
    return str.replace(/[^0-9]/g, "").length;
}

function setOperatorActive(op) {
    const ops = document.querySelectorAll('.calc-op');
    ops.forEach(btn => btn.classList.remove('op-active'));
    if (!op) return;
    const target = document.querySelector(`.calc-op[data-op="${op}"]`);
    if (target) target.classList.add('op-active');
}

function flashCalcButton(key) {
    const btn = document.querySelector(`.calc-btn[data-key="${key}"]`);
    if (!btn) return;
    if (btn.classList.contains('calc-op')) return;
    btn.classList.add('flash');
    setTimeout(() => {
        btn.classList.remove('flash');
    }, 120);
}

function updateACLabel() {
    const acBtn = document.getElementById('peek-calc-ac');
    if (!acBtn) return;
    const hasCurrent = calcCurrent !== "" && calcCurrent !== "0";
    if (hasCurrent) acBtn.innerText = "C";
    else acBtn.innerText = "AC";
}

function updateCalcDisplay(rawValue, exp) {
    const displayEl = document.getElementById('peek-calc-display');
    if (!displayEl) return;
    let text = String(rawValue);
    if (/e/i.test(text)) {
        displayEl.innerText = text;
    } else {
        const num = Number(text);
        if (!isFinite(num)) {
            displayEl.innerText = "Error";
        } else {
            const negative = text[0] === '-';
            let s = text.replace(/[^0-9.]/g, "");
            if (s === "" || s === ".") s = "0";
            const parts = s.split('.');
            let intPart = parts[0] || "0";
            let decPart = parts[1] || "";
            intPart = intPart.replace(/^0+(?=\d)/, "");
            if (intPart === "") intPart = "0";
            intPart = intPart.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            text = decPart ? intPart + "." + decPart : intPart;
            if (negative && text !== "0") text = "-" + text;
            displayEl.innerText = text;
        }
    }
    const digits = displayEl.innerText.replace(/[^0-9]/g, "");
    let size = 80;
    if (digits.length > 6) {
        const extra = digits.length - 6;
        size = 80 - extra * 7;
        if (size < 48) size = 48;
    }
    displayEl.style.fontSize = size + "px";
    updateACLabel();
    const expr = exp !== undefined ? exp : calcExpStr;
    syncToDevice(calcHistory + formatForOled(expr));
}

function performCalcOperation(a, b, op) {
    if (op === '+') return a + b;
    if (op === '-') return a - b;
    if (op === 'x') return a * b;
    if (op === '' || op === '/') return b === 0 ? NaN : a / b;
    return b;
}

function clearAllCalc() {
    calcHistory = "";
    calcCurrent = "0";
    calcStored = null;
    calcOperator = null;
    calcJustCalculated = false;
    calcInputReset = false;
    calcPrefixStr = "";
    calcExpStr = "";
    setOperatorActive(null);
    updateCalcDisplay(calcCurrent, "");
}

function clearEntryCalc() {
    calcCurrent = "0";
    calcJustCalculated = false;
    calcInputReset = false;
    if (!calcOperator && calcHistory === "") {
        calcPrefixStr = "";
        calcExpStr = "";
    }
    updateCalcDisplay(calcCurrent, calcExpStr);
}

function peekCalcBackspace() {
    if (calcJustCalculated) return;
    if (!calcCurrent || calcCurrent === "0") return;
    calcCurrent = calcCurrent.slice(0, -1);
    if (calcCurrent === "" || calcCurrent === "-" || calcCurrent === ".") calcCurrent = "0";
    let exprStr;
    if (calcOperator && calcPrefixStr) exprStr = calcPrefixStr + calcCurrent;
    else exprStr = calcCurrent;
    calcExpStr = exprStr;
    updateCalcDisplay(calcCurrent, calcExpStr);
}

function peekCalc(key) {
    const isOp = ['+', '-', 'x', '', '/'].includes(key);
    if (!isOp) flashCalcButton(key);
    if (key === 'C') {
        const hasCurrent = calcCurrent !== "" && calcCurrent !== "0";
        if (hasCurrent) clearEntryCalc();
        else clearAllCalc();
        return;
    }
    if (key === '=') {
        if (!calcOperator) {
            calcExpStr = calcCurrent;
            updateCalcDisplay(calcCurrent, calcExpStr);
            return;
        }
        const a = calcStored !== null ? calcStored : Number(calcCurrent || "0");
        const b = Number(calcCurrent || "0");
        const op = calcOperator;
        let result = performCalcOperation(a, b, op);
        const expr = String(a) + op + String(b);
        if (!isFinite(result)) {
            calcHistory += formatForOled(expr) + "=\nError\n";
            calcCurrent = "0";
            calcStored = null;
            calcOperator = null;
            calcExpStr = "";
            calcPrefixStr = "";
            calcJustCalculated = true;
            calcInputReset = true;
            setOperatorActive(null);
            updateCalcDisplay("Error", "");
            return;
        }
        let resStr = String(result);
        const plainDigits = resStr.replace(/[^0-9]/g, "");
        if (plainDigits.length > 9) {
            resStr = result.toExponential(0).replace('+', '');
        }
        calcHistory += formatForOled(expr) + "=\n" + resStr + "\n";
        calcCurrent = resStr;
        calcStored = result;
        calcOperator = null;
        calcExpStr = "";
        calcPrefixStr = "";
        calcJustCalculated = true;
        calcInputReset = true;
        setOperatorActive(null);
        updateCalcDisplay(calcCurrent, "");
        return;
    }
    if (isOp) {
        const currentVal = Number(calcCurrent || "0");
        if (calcStored !== null && calcOperator && !calcInputReset && !calcJustCalculated) {
            const result = performCalcOperation(calcStored, currentVal, calcOperator);
            calcStored = result;
            calcCurrent = String(result);
        } else {
            calcStored = currentVal;
        }
        calcOperator = key;
        calcJustCalculated = false;
        calcInputReset = true;
        calcPrefixStr = calcCurrent + key;
        calcExpStr = calcPrefixStr;
        setOperatorActive(key);
        updateCalcDisplay(calcCurrent, calcExpStr);
        return;
    }
    if (calcJustCalculated) {
        calcStored = null;
        calcOperator = null;
        calcPrefixStr = "";
        calcExpStr = "";
        calcJustCalculated = false;
    }
    let cur = calcCurrent;
    if (key === 'neg') {
        if (cur === "0") {
            updateCalcDisplay(cur, calcExpStr || cur);
            return;
        }
        if (cur.startsWith('-')) cur = cur.substring(1);
        else cur = '-' + cur;
    } else if (key === '%') {
        let base = Number(cur || "0");
        if (calcStored !== null && calcOperator) {
            base = calcStored * base / 100;
        } else {
            base = base / 100;
        }
        cur = String(base);
    } else if (key === '.') {
        if (!cur.includes('.')) cur += '.';
    } else if (key === '00') {
        for (let i = 0; i < 2; i++) {
            if (calcInputReset || cur === "0") {
                cur = "0";
                calcInputReset = false;
            } else {
                const digits = getCalcDigitCount(cur);
                if (digits >= 9) {
                    updateCalcDisplay(cur, calcExpStr || cur);
                    break;
                }
                cur += "0";
            }
        }
    } else {
        if (calcInputReset || cur === "0") {
            cur = key;
            calcInputReset = false;
        } else {
            const digits = getCalcDigitCount(cur);
            if (digits >= 9) {
                updateCalcDisplay(cur, calcExpStr || cur);
                return;
            }
            cur += key;
        }
    }
    calcCurrent = cur;
    let exprStr;
    if (calcOperator && calcPrefixStr) exprStr = calcPrefixStr + calcCurrent;
    else exprStr = calcCurrent;
    calcExpStr = exprStr;
    updateCalcDisplay(calcCurrent, calcExpStr);
}

// Password Logic
let peekPassVal = "";
let peekPassHistory = "";

function updatePeekPassDotsLayout() {
    const length = state.peekPassLength || 6;
    for (let i = 1; i <= 6; i++) {
        const dot = document.getElementById(`pd-${i}`);
        if (!dot) continue;
        if (i <= length) {
            dot.style.display = 'block';
        } else {
            dot.style.display = 'none';
            dot.classList.remove('filled');
        }
    }
}

function peekPass(key) {
    const maxLen = state.peekPassLength || 6;
    if(key === 'del') {
        if (peekPassVal.length > 0) peekPassVal = peekPassVal.slice(0, -1);
    } else {
        if(peekPassVal.length < maxLen) {
            peekPassVal += key;
        }
        
        if(peekPassVal.length === maxLen) {
             peekPassHistory += peekPassVal + "\n";
             const dotsContainer = document.getElementById('peek-pass-dots');
             if (navigator.vibrate) navigator.vibrate(200);
             if (dotsContainer) {
                 dotsContainer.classList.add('shake');
                 setTimeout(() => {
                     dotsContainer.classList.remove('shake');
                     peekPassVal = "";
                     for(let i=1; i<=6; i++) {
                        const dot = document.getElementById(`pd-${i}`);
                        if (dot) dot.classList.remove('filled');
                     }
                     syncToDevice(peekPassHistory);
                 }, 500);
             } else {
                 peekPassVal = "";
                 for(let i=1; i<=6; i++) {
                    const dot = document.getElementById(`pd-${i}`);
                    if (dot) dot.classList.remove('filled');
                 }
                 syncToDevice(peekPassHistory);
             }
             return;
        }
    }
    
    for(let i=1; i<=6; i++) {
        const dot = document.getElementById(`pd-${i}`);
        if(i <= peekPassVal.length) dot.classList.add('filled');
        else dot.classList.remove('filled');
    }
    
    syncToDevice(peekPassHistory + peekPassVal);
}

</script>
</body>
</html>
